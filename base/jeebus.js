(function() {
  var ng,
    __slice = [].slice;

  ng = angular.module('myApp');

  console.log('NG', angular.version.full);

  ng.config(function($urlRouterProvider, $locationProvider) {
    $urlRouterProvider.otherwise('/');
    return $locationProvider.html5Mode(true);
  });

  ng.factory('jeebus', function($rootScope, $q) {
    var attach, connect, detach, gadget, get, processModelUpdate, processRpcReply, put, rpc, rpcPromises, send, seqNum, trackedModels, ws;
    ws = null;
    seqNum = 0;
    rpcPromises = {};
    trackedModels = {};
    processModelUpdate = function(key, value) {
      var info, k, suffix;
      for (k in trackedModels) {
        info = trackedModels[k];
        if (k === key.slice(0, k.length)) {
          suffix = key.slice(k.length);
          if (value) {
            info.model[suffix] = value;
          } else {
            delete info.model[suffix];
          }
        }
      }
      if (!suffix) {
        return console.error("spurious model update", key, value);
      }
    };
    processRpcReply = function(reply) {
      var d, e, msg, n, result, t, _ref;
      n = reply[0], msg = reply[1], result = reply[2];
      _ref = rpcPromises[n], t = _ref[0], d = _ref[1], e = _ref[2];
      if (d) {
        clearTimeout(t);
        if (msg === true) {
          rpcPromises[n][1] = null;
          return d.resolve(function(ee) {
            return rpcPromises[n][2] = ee;
          });
        } else if (msg === "" && reply.length === 3) {
          return d.resolve(result);
        } else if (msg !== "" && reply.length === 2) {
          console.error(msg);
          return d.reject(msg);
        } else {
          return console.error.apply(console, ["bad rpc reply"].concat(__slice.call(reply)));
        }
      } else if (e) {
        if (msg === false) {
          if (reply.length > 2) {
            e.emit('error', result);
          } else {
            e.emit('close');
          }
          return delete rpcPromises[n];
        } else if (msg !== "" && reply.length > 2) {
          return e.emit(msg, reply.slice(2));
        } else {
          return console.error.apply(console, ["bad rpc event"].concat(__slice.call(reply)));
        }
      } else {
        return console.error.apply(console, ["spurious rpc reply"].concat(__slice.call(reply)));
      }
    };
    connect = function(appTag) {
      var reconnect;
      reconnect = function(firstCall) {
        ws = new WebSocket("ws://" + location.host + "/ws", [appTag]);
        ws.onopen = function() {
          console.log('WS Open');
          return $rootScope.$apply(function() {
            return $rootScope.serverStatus = 'connected';
          });
        };
        ws.onmessage = function(m) {
          if (m.data instanceof ArrayBuffer) {
            console.log('binary msg', m);
          }
          return $rootScope.$apply(function() {
            var data, e, k, v, _i, _len, _ref, _results, _results1;
            data = JSON.parse(m.data);
            switch (typeof data) {
              case 'object':
                if (Array.isArray(data)) {
                  return processRpcReply(data);
                } else {
                  _results = [];
                  for (k in data) {
                    v = data[k];
                    _results.push(processModelUpdate(k, v));
                  }
                  return _results;
                }
                break;
              case 'boolean':
                if (data) {
                  return window.location.reload(true);
                } else {
                  console.log("CSS Reload");
                  _ref = document.getElementsByTagName('link');
                  _results1 = [];
                  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                    e = _ref[_i];
                    if (e.href && /stylesheet/i.test(e.rel)) {
                      _results1.push(e.href = "" + (e.href.replace(/\?.*/, '')) + "?" + (Date.now()));
                    } else {
                      _results1.push(void 0);
                    }
                  }
                  return _results1;
                }
                break;
              default:
                return console.log('Server msg:', data);
            }
          });
        };
        return ws.onclose = function() {
          console.log('WS Closed');
          $rootScope.$apply(function() {
            return $rootScope.serverStatus = 'disconnected';
          });
          return setTimeout(reconnect, 1000);
        };
      };
      return reconnect(true);
    };
    send = function(payload) {
      ws.send(angular.toJson(payload));
      return this;
    };
    get = function(key) {
      return rpc('get', key);
    };
    put = function(key, value) {
      send([0, 'put', key, value]);
      return this;
    };
    rpc = function() {
      var args, cmd, d, n, t;
      cmd = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
      d = $q.defer();
      n = ++seqNum;
      ws.send(angular.toJson([cmd, n].concat(__slice.call(args))));
      t = setTimeout(function() {
        console.error("RPC " + n + ": no reponse", args);
        delete rpcPromises[n];
        return $rootScope.$apply(function() {
          return d.reject();
        });
      }, 10000);
      rpcPromises[n] = [t, d, null];
      return d.promise;
    };
    gadget = function() {
      var args, e;
      args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
      e = new EventEmitter;
      rpc.apply(null, args).then(function(eeSetter) {
        return eeSetter(e);
      });
      return e;
    };
    attach = function(path) {
      var info;
      info = trackedModels[path] != null ? trackedModels[path] : trackedModels[path] = {
        model: {},
        count: 0
      };
      if (info.count++ === 0) {
        rpc('attach', path).then(function(r) {
          var k, v;
          for (k in r) {
            v = r[k];
            processModelUpdate(k, v);
          }
          return console.log('attach', path);
        });
      }
      return info.model;
    };
    detach = function(path) {
      if (trackedModels[path] && --trackedModels[path].count <= 0) {
        delete trackedModels[path];
        rpc('detach', path).then(function() {
          return console.log('detach', path);
        });
      }
      return this;
    };
    window.send = send;
    return {
      connect: connect,
      send: send,
      get: get,
      put: put,
      rpc: rpc,
      gadget: gadget,
      attach: attach,
      detach: detach
    };
  });

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiamVlYnVzLmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUFBLE1BQUEsRUFBQTtJQUFBLGtCQUFBOztBQUFBLEVBQUEsRUFBQSxHQUFLLE9BQU8sQ0FBQyxNQUFSLENBQWUsT0FBZixDQUFMLENBQUE7O0FBQUEsRUFFQSxPQUFPLENBQUMsR0FBUixDQUFZLElBQVosRUFBa0IsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFsQyxDQUZBLENBQUE7O0FBQUEsRUFJQSxFQUFFLENBQUMsTUFBSCxDQUFVLFNBQUMsa0JBQUQsRUFBcUIsaUJBQXJCLEdBQUE7QUFDUixJQUFBLGtCQUFrQixDQUFDLFNBQW5CLENBQTZCLEdBQTdCLENBQUEsQ0FBQTtXQUNBLGlCQUFpQixDQUFDLFNBQWxCLENBQTRCLElBQTVCLEVBRlE7RUFBQSxDQUFWLENBSkEsQ0FBQTs7QUFBQSxFQVVBLEVBQUUsQ0FBQyxPQUFILENBQVcsUUFBWCxFQUFxQixTQUFDLFVBQUQsRUFBYSxFQUFiLEdBQUE7QUFDbkIsUUFBQSxpSUFBQTtBQUFBLElBQUEsRUFBQSxHQUFLLElBQUwsQ0FBQTtBQUFBLElBQ0EsTUFBQSxHQUFTLENBRFQsQ0FBQTtBQUFBLElBRUEsV0FBQSxHQUFjLEVBRmQsQ0FBQTtBQUFBLElBR0EsYUFBQSxHQUFnQixFQUhoQixDQUFBO0FBQUEsSUFNQSxrQkFBQSxHQUFxQixTQUFDLEdBQUQsRUFBTSxLQUFOLEdBQUE7QUFDbkIsVUFBQSxlQUFBO0FBQUEsV0FBQSxrQkFBQTtnQ0FBQTtBQUNFLFFBQUEsSUFBRyxDQUFBLEtBQUssR0FBRyxDQUFDLEtBQUosQ0FBVSxDQUFWLEVBQWEsQ0FBQyxDQUFDLE1BQWYsQ0FBUjtBQUNFLFVBQUEsTUFBQSxHQUFTLEdBQUcsQ0FBQyxLQUFKLENBQVUsQ0FBQyxDQUFDLE1BQVosQ0FBVCxDQUFBO0FBQ0EsVUFBQSxJQUFHLEtBQUg7QUFDRSxZQUFBLElBQUksQ0FBQyxLQUFN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RDtBQUFBLE1BQVMsTUFBQSxJQUFUO0FBQUEsTUFBYyxLQUFBLEdBQWQ7QUFBQSxNQUFrQixLQUFBLEdBQWxCO0FBQUEsTUFBc0IsS0FBQSxHQUF0QjtBQUFBLE1BQTBCLFFBQUEsTUFBMUI7QUFBQSxNQUFpQyxRQUFBLE1BQWpDO0FBQUEsTUFBd0MsUUFBQSxNQUF4QztNQXpKbUI7RUFBQSxDQUFyQixDQVZBLENBQUE7QUFBQSIsInNvdXJjZXNDb250ZW50IjpbIm5nID0gYW5ndWxhci5tb2R1bGUgJ215QXBwJ1xuXG5jb25zb2xlLmxvZyAnTkcnLCBhbmd1bGFyLnZlcnNpb24uZnVsbFxuXG5uZy5jb25maWcgKCR1cmxSb3V0ZXJQcm92aWRlciwgJGxvY2F0aW9uUHJvdmlkZXIpIC0+XG4gICR1cmxSb3V0ZXJQcm92aWRlci5vdGhlcndpc2UgJy8nXG4gICRsb2NhdGlvblByb3ZpZGVyLmh0bWw1TW9kZSB0cnVlXG4gIFxuIyBUaGUgXCJqZWVidXNcIiBzZXJ2aWNlIGJlbG93IGlzIHRoZSBzYW1lIGZvciBhbGwgY2xpZW50LXNpZGUgYXBwbGljYXRpb25zLlxuIyBJdCBsZXRzIGFuZ3VsYXIgY29ubmVjdCB0byB0aGUgSmVlQnVzIHNlcnZlciBhbmQgc2VuZC9yZWNlaXZlIG1lc3NhZ2VzLlxubmcuZmFjdG9yeSAnamVlYnVzJywgKCRyb290U2NvcGUsICRxKSAtPlxuICB3cyA9IG51bGwgICAgICAgICAgIyB0aGUgd2Vic29ja2V0IG9iamVjdCwgd2hpbGUgb3BlblxuICBzZXFOdW0gPSAwICAgICAgICAgIyB1bmlxdWUgc2VxdWVuY2UgbnVtYmVycyBmb3IgZWFjaCBSUEMgcmVxdWVzdFxuICBycGNQcm9taXNlcyA9IHt9ICAgIyBtYXBzIHNlcU51bSB0byBhIHBlbmRpbmcgPHRpbWVySWQscHJvbWlzZSxlbWl0dGVyPiBlbnRyeVxuICB0cmFja2VkTW9kZWxzID0ge30gIyBrZWVwcyB0cmFjayBvZiB3aGljaCBwYXRocyBoYXZlIGJlZW4gYXR0YWNoZWRcblxuICAjIFVwZGF0ZSBvbmUgb3IgbW9yZSBvZiB0aGUgdHJhY2tlZCBtb2RlbHMgd2l0aCBhbiBpbmNvbWluZyBjaGFuZ2UuXG4gIHByb2Nlc3NNb2RlbFVwZGF0ZSA9IChrZXksIHZhbHVlKSAtPlxuICAgIGZvciBrLCBpbmZvIG9mIHRyYWNrZWRNb2RlbHNcbiAgICAgIGlmIGsgaXMga2V5LnNsaWNlKDAsIGsubGVuZ3RoKVxuICAgICAgICBzdWZmaXggPSBrZXkuc2xpY2Uoay5sZW5ndGgpXG4gICAgICAgIGlmIHZhbHVlXG4gICAgICAgICAgaW5mby5tb2RlbFtzdWZmaXhdID0gdmFsdWVcbiAgICAgICAgZWxzZVxuICAgICAgICAgIGRlbGV0ZSBpbmZvLm1vZGVsW3N1ZmZpeF1cbiAgICBjb25zb2xlLmVycm9yIFwic3B1cmlvdXMgbW9kZWwgdXBkYXRlXCIsIGtleSwgdmFsdWUgIHVubGVzcyBzdWZmaXhcblxuICAjIFJlc29sdmUgb3IgcmVqZWN0IGEgcGVuZGluZyBycGMgcHJvbWlzZS5cbiAgcHJvY2Vzc1JwY1JlcGx5ID0gKHJlcGx5KSAtPlxuICAgIFtuLG1zZyxyZXN1bHRdID0gcmVwbHlcbiAgICBbdCxkLGVdID0gcnBjUHJvbWlzZXNbbl1cbiAgICBpZiBkXG4gICAgICBjbGVhclRpbWVvdXQgdFxuICAgICAgaWYgbXNnIGlzIHRydWUgIyBzdGFydCBzdHJlYW1pbmdcbiAgICAgICAgcnBjUHJvbWlzZXNbbl1bMV0gPSBudWxsXG4gICAgICAgIGQucmVzb2x2ZSAoZWUpIC0+XG4gICAgICAgICAgcnBjUHJvbWlzZXNbbl1bMl0gPSBlZVxuICAgICAgZWxzZSBpZiBtc2cgaXMgXCJcIiBhbmQgcmVwbHkubGVuZ3RoIGlzIDNcbiAgICAgICAgZC5yZXNvbHZlIHJlc3VsdFxuICAgICAgZWxzZSBpZiBtc2cgaXNudCBcIlwiIGFuZCByZXBseS5sZW5ndGggaXMgMlxuICAgICAgICBjb25zb2xlLmVycm9yIG1zZ1xuICAgICAgICBkLnJlamVjdCBtc2dcbiAgICAgIGVsc2VcbiAgICAgICAgY29uc29sZS5lcnJvciBcImJhZCBycGMgcmVwbHlcIiwgcmVwbHkuLi5cbiAgICBlbHNlIGlmIGVcbiAgICAgIGlmIG1zZyBpcyBmYWxzZSAjIHN0b3Agc3RyZWFtaW5nXG4gICAgICAgIGlmIHJlcGx5Lmxlbmd0aCA+IDJcbiAgICAgICAgICBlLmVtaXQgJ2Vycm9yJywgcmVzdWx0XG4gICAgICAgIGVsc2VcbiAgICAgICAgICBlLmVtaXQgJ2Nsb3NlJ1xuICAgICAgICBkZWxldGUgcnBjUHJvbWlzZXNbbl1cbiAgICAgIGVsc2UgaWYgbXNnIGlzbnQgXCJcIiBhbmQgcmVwbHkubGVuZ3RoID4gMlxuICAgICAgICBlLmVtaXQgbXNnLCByZXBseS5zbGljZSgyKVxuICAgICAgZWxzZVxuICAgICAgICBjb25zb2xlLmVycm9yIFwiYmFkIHJwYyBldmVudFwiLCByZXBseS4uLlxuICAgIGVsc2VcbiAgICAgIGNvbnNvbGUuZXJyb3IgXCJzcHVyaW91cyBycGMgcmVwbHlcIiwgcmVwbHkuLi5cblxuICAjIFNldCB1cCBhIHdlYnNvY2tldCBjb25uZWN0aW9uIHRvIHRoZSBKZWVCdXMgc2VydmVyLlxuICAjIFRoZSBhcHBUYWcgaXMgdGhlIGRlZmF1bHQgdGFnIHRvIHVzZSB3aGVuIHNlbmRpbmcgcmVxdWVzdHMgdG8gaXQuXG4gIGNvbm5lY3QgPSAoYXBwVGFnKSAtPlxuXG4gICAgcmVjb25uZWN0ID0gKGZpcnN0Q2FsbCkgLT5cbiAgICAgICMgdGhlIHdlYnNvY2tldCBpcyBzZXJ2ZWQgZnJvbSB0aGUgc2FtZSBzaXRlIGFzIHRoZSB3ZWIgcGFnZVxuICAgICAgd3MgPSBuZXcgV2ViU29ja2V0IFwid3M6Ly8je2xvY2F0aW9uLmhvc3R9L3dzXCIsIFthcHBUYWddXG5cbiAgICAgIHdzLm9ub3BlbiA9IC0+XG4gICAgICAgICMgbG9jYXRpb24ucmVsb2FkKCkgIHVubGVzcyBmaXJzdENhbGxcbiAgICAgICAgY29uc29sZS5sb2cgJ1dTIE9wZW4nXG4gICAgICAgICRyb290U2NvcGUuJGFwcGx5IC0+XG4gICAgICAgICAgJHJvb3RTY29wZS5zZXJ2ZXJTdGF0dXMgPSAnY29ubmVjdGVkJ1xuXG4gICAgICB3cy5vbm1lc3NhZ2UgPSAobSkgLT5cbiAgICAgICAgaWYgbS5kYXRhIGluc3RhbmNlb2YgQXJyYXlCdWZmZXJcbiAgICAgICAgICBjb25zb2xlLmxvZyAnYmluYXJ5IG1zZycsIG1cbiAgICAgICAgJHJvb3RTY29wZS4kYXBwbHkgLT5cbiAgICAgICAgICBkYXRhID0gSlNPTi5wYXJzZSBtLmRhdGFcbiAgICAgICAgICBzd2l0Y2ggdHlwZW9mIGRhdGFcbiAgICAgICAgICAgIHdoZW4gJ29iamVjdCdcbiAgICAgICAgICAgICAgaWYgQXJyYXkuaXNBcnJheSBkYXRhXG4gICAgICAgICAgICAgICAgcHJvY2Vzc1JwY1JlcGx5IGRhdGFcbiAgICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgIGZvciBrLCB2IG9mIGRhdGFcbiAgICAgICAgICAgICAgICAgIHByb2Nlc3NNb2RlbFVwZGF0ZSBrLCB2XG4gICAgICAgICAgICB3aGVuICdib29sZWFuJ1xuICAgICAgICAgICAgICBpZiBkYXRhICMgcmVsb2FkIGFwcFxuICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5yZWxvYWQgdHJ1ZVxuICAgICAgICAgICAgICBlbHNlICMgcmVmcmVzaCBzdHlsZXNoZWV0c1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nIFwiQ1NTIFJlbG9hZFwiXG4gICAgICAgICAgICAgICAgZm9yIGUgaW4gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgJ2xpbmsnXG4gICAgICAgICAgICAgICAgICBpZiBlLmhyZWYgYW5kIC9zdHlsZXNoZWV0L2kudGVzdCBlLnJlbFxuICAgICAgICAgICAgICAgICAgICBlLmhyZWYgPSBcIiN7ZS5ocmVmLnJlcGxhY2UgL1xcPy4qLywgJyd9PyN7RGF0ZS5ub3coKX1cIlxuICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICBjb25zb2xlLmxvZyAnU2VydmVyIG1zZzonLCBkYXRhXG5cbiAgICAgICMgd3Mub25lcnJvciA9IChlKSAtPlxuICAgICAgIyAgIGNvbnNvbGUubG9nICdFcnJvcicsIGVcblxuICAgICAgd3Mub25jbG9zZSA9IC0+XG4gICAgICAgIGNvbnNvbGUubG9nICdXUyBDbG9zZWQnXG4gICAgICAgICRyb290U2NvcGUuJGFwcGx5IC0+XG4gICAgICAgICAgJHJvb3RTY29wZS5zZXJ2ZXJTdGF0dXMgPSAnZGlzY29ubmVjdGVkJ1xuICAgICAgICBzZXRUaW1lb3V0IHJlY29ubmVjdCwgMTAwMFxuXG4gICAgcmVjb25uZWN0IHRydWVcbiAgIFxuICAjIFNlbmQgYSBwYXlsb2FkIHRvIHRoZSBKZWVCdXMgc2VydmVyIG92ZXIgdGhlIHdlYnNvY2tldCBjb25uZWN0aW9uLlxuICAjIFRoZSBwYXlsb2FkIHNob3VsZCBiZSBhbiBvYmplY3QgKGFueXRoaW5nIGJ1dCBhcnJheSBpcyBzdXBwb3J0ZWQgZm9yIG5vdykuXG4gIHNlbmQgPSAocGF5bG9hZCkgLT5cbiAgICB3cy5zZW5kIGFuZ3VsYXIudG9Kc29uIHBheWxvYWRcbiAgICBAXG5cbiAgIyBGZXRjaCBhIGtleS92YWx1ZSBwYWlyIGZyb20gdGhlIHNlcnZlciBkYXRhYmFzZSwgdmFsdWUgcmV0dXJuZWQgYXMgcHJvbWlzZS5cbiAgZ2V0ID0gKGtleSkgLT5cbiAgICBycGMgJ2dldCcsIGtleVxuICAgICAgXG4gICMgU3RvcmUgYSBrZXkvdmFsdWUgcGFpciBpbiB0aGUgc2VydmVyIGRhdGFiYXNlLlxuICBwdXQgPSAoa2V5LCB2YWx1ZSkgLT5cbiAgICBzZW5kIFswLCAncHV0Jywga2V5LCB2YWx1ZV1cbiAgICBAXG4gICAgICBcbiAgIyBQZXJmb3JtIGFuIFJQQyBjYWxsLCBpLmUuIHJlZ2lzdGVyIHJlc3VsdCBjYWxsYmFjayBhbmQgcmV0dXJuIGEgcHJvbWlzZS5cbiAgcnBjID0gKGNtZCwgYXJncy4uLikgLT5cbiAgICBkID0gJHEuZGVmZXIoKVxuICAgIG4gPSArK3NlcU51bVxuICAgIHdzLnNlbmQgYW5ndWxhci50b0pzb24gW2NtZCwgbiwgYXJncy4uLl1cbiAgICB0ID0gc2V0VGltZW91dCAtPlxuICAgICAgY29uc29sZS5lcnJvciBcIlJQQyAje259OiBubyByZXBvbnNlXCIsIGFyZ3NcbiAgICAgIGRlbGV0ZSBycGNQcm9taXNlc1tuXVxuICAgICAgJHJvb3RTY29wZS4kYXBwbHkgLT5cbiAgICAgICAgZC5yZWplY3QoKVxuICAgICwgMTAwMDAgIyAxMCBzZWNvbmRzIHNob3VsZCBiZSBlbm91Z2ggdG8gY29tcGxldGUgYW55IHJlcXVlc3RcbiAgICBycGNQcm9taXNlc1tuXSA9IFt0LCBkLCBudWxsXVxuICAgIGQucHJvbWlzZVxuXG4gICMgTGF1bmNoIGEgZ2FkZ2V0IG9uIHRoZSBzZXJ2ZXIgYW5kIHJldHVybiBpdHMgcmVzdWx0cyB2aWEgZXZlbnRzLlxuICBnYWRnZXQgPSAoYXJncy4uLikgLT5cbiAgICBlID0gbmV3IEV2ZW50RW1pdHRlclxuICAgIHJwYyBhcmdzLi4uXG4gICAgICAudGhlbiAoZWVTZXR0ZXIpIC0+XG4gICAgICAgIGVlU2V0dGVyIGVcbiAgICBlXG4gIFxuICAjIEF0dGFjaCwgaS5lLiBnZXQgY29ycmVzcG9uZGluZyBkYXRhIGFzIGEgbW9kZWwgd2hpY2ggdHJhY2tzIGFsbCBjaGFuZ2VzLlxuICBhdHRhY2ggPSAocGF0aCkgLT5cbiAgICBpbmZvID0gdHJhY2tlZE1vZGVsc1twYXRoXSA/PSB7IG1vZGVsOiB7fSwgY291bnQ6IDAgfVxuICAgIGlmIGluZm8uY291bnQrKyBpcyAwXG4gICAgICBycGMgJ2F0dGFjaCcsIHBhdGhcbiAgICAgICAgLnRoZW4gKHIpIC0+XG4gICAgICAgICAgZm9yIGssIHYgb2YgclxuICAgICAgICAgICAgcHJvY2Vzc01vZGVsVXBkYXRlIGssIHZcbiAgICAgICAgICBjb25zb2xlLmxvZyAnYXR0YWNoJywgcGF0aFxuICAgIGluZm8ubW9kZWxcblxuICAjIFVuZG8gdGhlIGVmZmVjdHMgb2YgYXR0YWNoaW5nLCBpLmUuIHN0b3AgZm9sbG93aW5nIGNoYW5nZXMuXG4gIGRldGFjaCA9IChwYXRoKSAtPlxuICAgIGlmIHRyYWNrZWRNb2RlbHNbcGF0aF0gJiYgLS10cmFja2VkTW9kZWxzW3BhdGhdLmNvdW50IDw9IDBcbiAgICAgIGRlbGV0ZSB0cmFja2VkTW9kZWxzW3BhdGhdXG4gICAgICBycGMgJ2RldGFjaCcsIHBhdGhcbiAgICAgICAgLnRoZW4gLT4gY29uc29sZS5sb2cgJ2RldGFjaCcsIHBhdGhcbiAgICBAXG5cbiAgd2luZG93LnNlbmQgPSBzZW5kICMgY29uc29sZSBhY2Nlc3MsIGZvciBkZWJ1Z2dpbmdcbiAge2Nvbm5lY3Qsc2VuZCxnZXQscHV0LHJwYyxnYWRnZXQsYXR0YWNoLGRldGFjaH1cbiJdfQ==
