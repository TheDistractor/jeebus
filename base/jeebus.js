(function() {
  var ng,
    __slice = [].slice;

  ng = angular.module('myApp');

  console.log('NG', angular.version.full);

  ng.config(function($urlRouterProvider, $locationProvider) {
    $urlRouterProvider.otherwise('/');
    return $locationProvider.html5Mode(true);
  });

  ng.factory('jeebus', function($rootScope, $q) {
    var attach, connect, detach, gadget, get, processModelUpdate, processRpcReply, put, rpc, rpcPromises, send, seqNum, trackedModels, ws;
    ws = null;
    seqNum = 0;
    rpcPromises = {};
    trackedModels = {};
    processModelUpdate = function(key, value) {
      var info, k, suffix;
      for (k in trackedModels) {
        info = trackedModels[k];
        if (k === key.slice(0, k.length)) {
          suffix = key.slice(k.length);
          if (value) {
            info.model[suffix] = value;
          } else {
            delete info.model[suffix];
          }
        }
      }
      if (!suffix) {
        return console.error("spurious model update", key, value);
      }
    };
    processRpcReply = function(reply) {
      var d, e, msg, n, result, t, _ref;
      n = reply[0], msg = reply[1], result = reply[2];
      _ref = rpcPromises[n], t = _ref[0], d = _ref[1], e = _ref[2];
      if (d) {
        clearTimeout(t);
        if (msg === true) {
          rpcPromises[n][1] = null;
          return d.resolve(function(ee) {
            return rpcPromises[n][2] = ee;
          });
        } else if (msg === "" && reply.length === 3) {
          return d.resolve(result);
        } else if (msg !== "" && reply.length === 2) {
          console.error(msg);
          return d.reject(msg);
        } else {
          return console.error.apply(console, ["bad rpc reply"].concat(__slice.call(reply)));
        }
      } else if (e) {
        if (msg === false) {
          if (reply.length > 2) {
            e.emit('error', result);
          } else {
            e.emit('close');
          }
          return delete rpcPromises[n];
        } else if (msg !== "" && reply.length === 3) {
          return e.emit(msg, result);
        } else {
          return console.error.apply(console, ["bad rpc event"].concat(__slice.call(reply)));
        }
      } else {
        return console.error.apply(console, ["spurious rpc reply"].concat(__slice.call(reply)));
      }
    };
    connect = function(appTag) {
      var reconnect;
      reconnect = function(firstCall) {
        ws = new WebSocket("ws://" + location.host + "/ws", [appTag]);
        ws.onopen = function() {
          console.log('WS Open');
          return $rootScope.$apply(function() {
            return $rootScope.$broadcast('ws-open');
          });
        };
        ws.onmessage = function(m) {
          if (m.data instanceof ArrayBuffer) {
            console.log('binary msg', m);
          }
          return $rootScope.$apply(function() {
            var data, e, k, v, _i, _len, _ref, _results, _results1;
            data = JSON.parse(m.data);
            switch (typeof data) {
              case 'object':
                if (Array.isArray(data)) {
                  return processRpcReply(data);
                } else {
                  _results = [];
                  for (k in data) {
                    v = data[k];
                    _results.push(processModelUpdate(k, v));
                  }
                  return _results;
                }
                break;
              case 'boolean':
                if (data) {
                  return window.location.reload(true);
                } else {
                  console.log("CSS Reload");
                  _ref = document.getElementsByTagName('link');
                  _results1 = [];
                  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                    e = _ref[_i];
                    if (e.href && /stylesheet/i.test(e.rel)) {
                      _results1.push(e.href = "" + (e.href.replace(/\?.*/, '')) + "?" + (Date.now()));
                    } else {
                      _results1.push(void 0);
                    }
                  }
                  return _results1;
                }
                break;
              default:
                return console.log('Server msg:', data);
            }
          });
        };
        return ws.onclose = function() {
          console.log('WS Lost');
          $rootScope.$apply(function() {
            return $rootScope.$broadcast('ws-lost');
          });
          return setTimeout(reconnect, 1000);
        };
      };
      return reconnect(true);
    };
    send = function(payload) {
      ws.send(angular.toJson(payload));
      return this;
    };
    get = function(key) {
      return rpc('get', key);
    };
    put = function(key, value) {
      send([0, 'put', key, value]);
      return this;
    };
    rpc = function() {
      var args, cmd, d, n, t;
      cmd = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
      d = $q.defer();
      n = ++seqNum;
      ws.send(angular.toJson([cmd, n].concat(__slice.call(args))));
      t = setTimeout(function() {
        console.error("RPC " + n + ": no reponse", args);
        delete rpcPromises[n];
        return $rootScope.$apply(function() {
          return d.reject();
        });
      }, 10000);
      rpcPromises[n] = [t, d, null];
      return d.promise;
    };
    gadget = function() {
      var args, e;
      args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
      e = new EventEmitter;
      rpc.apply(null, args).then(function(eeSetter) {
        return eeSetter(e);
      });
      return e;
    };
    attach = function(path) {
      var info;
      info = trackedModels[path] != null ? trackedModels[path] : trackedModels[path] = {
        model: {},
        count: 0
      };
      if (info.count++ === 0) {
        rpc('attach', path).then(function(r) {
          var k, v;
          for (k in r) {
            v = r[k];
            processModelUpdate(k, v);
          }
          return console.log('attach', path);
        });
      }
      return info.model;
    };
    detach = function(path) {
      if (trackedModels[path] && --trackedModels[path].count <= 0) {
        delete trackedModels[path];
        rpc('detach', path).then(function() {
          return console.log('detach', path);
        });
      }
      return this;
    };
    window.send = send;
    return {
      connect: connect,
      send: send,
      get: get,
      put: put,
      rpc: rpc,
      gadget: gadget,
      attach: attach,
      detach: detach
    };
  });

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiamVlYnVzLmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUFBLE1BQUEsRUFBQTtJQUFBLGtCQUFBOztBQUFBLEVBQUEsRUFBQSxHQUFLLE9BQU8sQ0FBQyxNQUFSLENBQWUsT0FBZixDQUFMLENBQUE7O0FBQUEsRUFFQSxPQUFPLENBQUMsR0FBUixDQUFZLElBQVosRUFBa0IsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFsQyxDQUZBLENBQUE7O0FBQUEsRUFJQSxFQUFFLENBQUMsTUFBSCxDQUFVLFNBQUMsa0JBQUQsRUFBcUIsaUJBQXJCLEdBQUE7QUFDUixJQUFBLGtCQUFrQixDQUFDLFNBQW5CLENBQTZCLEdBQTdCLENBQUEsQ0FBQTtXQUNBLGlCQUFpQixDQUFDLFNBQWxCLENBQTRCLElBQTVCLEVBRlE7RUFBQSxDQUFWLENBSkEsQ0FBQTs7QUFBQSxFQVVBLEVBQUUsQ0FBQyxPQUFILENBQVcsUUFBWCxFQUFxQixTQUFDLFVBQUQsRUFBYSxFQUFiLEdBQUE7QUFDbkIsUUFBQSxpSUFBQTtBQUFBLElBQUEsRUFBQSxHQUFLLElBQUwsQ0FBQTtBQUFBLElBQ0EsTUFBQSxHQUFTLENBRFQsQ0FBQTtBQUFBLElBRUEsV0FBQSxHQUFjLEVBRmQsQ0FBQTtBQUFBLElBR0EsYUFBQSxHQUFnQixFQUhoQixDQUFBO0FBQUEsSUFNQSxrQkFBQSxHQUFxQixTQUFDLEdBQUQsRUFBTSxLQUFOLEdBQUE7QUFDbkIsVUFBQSxlQUFBO0FBQUEsV0FBQSxrQkFBQTtnQ0FBQTtBQUNFLFFBQUEsSUFBRyxDQUFBLEtBQUssR0FBRyxDQUFDLEtBQUosQ0FBVSxDQUFWLEVBQWEsQ0FBQyxDQUFDLE1BQWYsQ0FBUjtBQUNFLFVBQUEsTUFBQSxHQUFTLEdBQUcsQ0FBQyxLQUFKLENBQVUsQ0FBQyxDQUFDLE1BQVosQ0FBVCxDQUFBO0FBQ0EsVUFBQSxJQUFHLEtBQUg7QUFDRSxZQUFBLElBQUksQ0FBQyxLQUFN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UyxNQUFBLElBQVQ7QUFBQSxNQUFjLEtBQUEsR0FBZDtBQUFBLE1BQWtCLEtBQUEsR0FBbEI7QUFBQSxNQUFzQixLQUFBLEdBQXRCO0FBQUEsTUFBMEIsUUFBQSxNQUExQjtBQUFBLE1BQWlDLFFBQUEsTUFBakM7QUFBQSxNQUF3QyxRQUFBLE1BQXhDO01BekptQjtFQUFBLENBQXJCLENBVkEsQ0FBQTtBQUFBIiwic291cmNlc0NvbnRlbnQiOlsibmcgPSBhbmd1bGFyLm1vZHVsZSAnbXlBcHAnXG5cbmNvbnNvbGUubG9nICdORycsIGFuZ3VsYXIudmVyc2lvbi5mdWxsXG5cbm5nLmNvbmZpZyAoJHVybFJvdXRlclByb3ZpZGVyLCAkbG9jYXRpb25Qcm92aWRlcikgLT5cbiAgJHVybFJvdXRlclByb3ZpZGVyLm90aGVyd2lzZSAnLydcbiAgJGxvY2F0aW9uUHJvdmlkZXIuaHRtbDVNb2RlIHRydWVcbiAgXG4jIFRoZSBcImplZWJ1c1wiIHNlcnZpY2UgYmVsb3cgaXMgdGhlIHNhbWUgZm9yIGFsbCBjbGllbnQtc2lkZSBhcHBsaWNhdGlvbnMuXG4jIEl0IGxldHMgYW5ndWxhciBjb25uZWN0IHRvIHRoZSBKZWVCdXMgc2VydmVyIGFuZCBzZW5kL3JlY2VpdmUgbWVzc2FnZXMuXG5uZy5mYWN0b3J5ICdqZWVidXMnLCAoJHJvb3RTY29wZSwgJHEpIC0+XG4gIHdzID0gbnVsbCAgICAgICAgICAjIHRoZSB3ZWJzb2NrZXQgb2JqZWN0LCB3aGlsZSBvcGVuXG4gIHNlcU51bSA9IDAgICAgICAgICAjIHVuaXF1ZSBzZXF1ZW5jZSBudW1iZXJzIGZvciBlYWNoIFJQQyByZXF1ZXN0XG4gIHJwY1Byb21pc2VzID0ge30gICAjIG1hcHMgc2VxTnVtIHRvIGEgcGVuZGluZyA8dGltZXJJZCxwcm9taXNlLGVtaXR0ZXI+IGVudHJ5XG4gIHRyYWNrZWRNb2RlbHMgPSB7fSAjIGtlZXBzIHRyYWNrIG9mIHdoaWNoIHBhdGhzIGhhdmUgYmVlbiBhdHRhY2hlZFxuXG4gICMgVXBkYXRlIG9uZSBvciBtb3JlIG9mIHRoZSB0cmFja2VkIG1vZGVscyB3aXRoIGFuIGluY29taW5nIGNoYW5nZS5cbiAgcHJvY2Vzc01vZGVsVXBkYXRlID0gKGtleSwgdmFsdWUpIC0+XG4gICAgZm9yIGssIGluZm8gb2YgdHJhY2tlZE1vZGVsc1xuICAgICAgaWYgayBpcyBrZXkuc2xpY2UoMCwgay5sZW5ndGgpXG4gICAgICAgIHN1ZmZpeCA9IGtleS5zbGljZShrLmxlbmd0aClcbiAgICAgICAgaWYgdmFsdWVcbiAgICAgICAgICBpbmZvLm1vZGVsW3N1ZmZpeF0gPSB2YWx1ZVxuICAgICAgICBlbHNlXG4gICAgICAgICAgZGVsZXRlIGluZm8ubW9kZWxbc3VmZml4XVxuICAgIGNvbnNvbGUuZXJyb3IgXCJzcHVyaW91cyBtb2RlbCB1cGRhdGVcIiwga2V5LCB2YWx1ZSAgdW5sZXNzIHN1ZmZpeFxuXG4gICMgUmVzb2x2ZSBvciByZWplY3QgYSBwZW5kaW5nIHJwYyBwcm9taXNlLlxuICBwcm9jZXNzUnBjUmVwbHkgPSAocmVwbHkpIC0+XG4gICAgW24sbXNnLHJlc3VsdF0gPSByZXBseVxuICAgIFt0LGQsZV0gPSBycGNQcm9taXNlc1tuXVxuICAgIGlmIGRcbiAgICAgIGNsZWFyVGltZW91dCB0XG4gICAgICBpZiBtc2cgaXMgdHJ1ZSAjIHN0YXJ0IHN0cmVhbWluZ1xuICAgICAgICBycGNQcm9taXNlc1tuXVsxXSA9IG51bGxcbiAgICAgICAgZC5yZXNvbHZlIChlZSkgLT5cbiAgICAgICAgICBycGNQcm9taXNlc1tuXVsyXSA9IGVlXG4gICAgICBlbHNlIGlmIG1zZyBpcyBcIlwiIGFuZCByZXBseS5sZW5ndGggaXMgM1xuICAgICAgICBkLnJlc29sdmUgcmVzdWx0XG4gICAgICBlbHNlIGlmIG1zZyBpc250IFwiXCIgYW5kIHJlcGx5Lmxlbmd0aCBpcyAyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IgbXNnXG4gICAgICAgIGQucmVqZWN0IG1zZ1xuICAgICAgZWxzZVxuICAgICAgICBjb25zb2xlLmVycm9yIFwiYmFkIHJwYyByZXBseVwiLCByZXBseS4uLlxuICAgIGVsc2UgaWYgZVxuICAgICAgaWYgbXNnIGlzIGZhbHNlICMgc3RvcCBzdHJlYW1pbmdcbiAgICAgICAgaWYgcmVwbHkubGVuZ3RoID4gMlxuICAgICAgICAgIGUuZW1pdCAnZXJyb3InLCByZXN1bHRcbiAgICAgICAgZWxzZVxuICAgICAgICAgIGUuZW1pdCAnY2xvc2UnXG4gICAgICAgIGRlbGV0ZSBycGNQcm9taXNlc1tuXVxuICAgICAgZWxzZSBpZiBtc2cgaXNudCBcIlwiIGFuZCByZXBseS5sZW5ndGggaXMgM1xuICAgICAgICBlLmVtaXQgbXNnLCByZXN1bHRcbiAgICAgIGVsc2VcbiAgICAgICAgY29uc29sZS5lcnJvciBcImJhZCBycGMgZXZlbnRcIiwgcmVwbHkuLi5cbiAgICBlbHNlXG4gICAgICBjb25zb2xlLmVycm9yIFwic3B1cmlvdXMgcnBjIHJlcGx5XCIsIHJlcGx5Li4uXG5cbiAgIyBTZXQgdXAgYSB3ZWJzb2NrZXQgY29ubmVjdGlvbiB0byB0aGUgSmVlQnVzIHNlcnZlci5cbiAgIyBUaGUgYXBwVGFnIGlzIHRoZSBkZWZhdWx0IHRhZyB0byB1c2Ugd2hlbiBzZW5kaW5nIHJlcXVlc3RzIHRvIGl0LlxuICBjb25uZWN0ID0gKGFwcFRhZykgLT5cblxuICAgIHJlY29ubmVjdCA9IChmaXJzdENhbGwpIC0+XG4gICAgICAjIHRoZSB3ZWJzb2NrZXQgaXMgc2VydmVkIGZyb20gdGhlIHNhbWUgc2l0ZSBhcyB0aGUgd2ViIHBhZ2VcbiAgICAgIHdzID0gbmV3IFdlYlNvY2tldCBcIndzOi8vI3tsb2NhdGlvbi5ob3N0fS93c1wiLCBbYXBwVGFnXVxuXG4gICAgICB3cy5vbm9wZW4gPSAtPlxuICAgICAgICAjIGxvY2F0aW9uLnJlbG9hZCgpICB1bmxlc3MgZmlyc3RDYWxsXG4gICAgICAgIGNvbnNvbGUubG9nICdXUyBPcGVuJ1xuICAgICAgICAkcm9vdFNjb3BlLiRhcHBseSAtPlxuICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCAnd3Mtb3BlbidcblxuICAgICAgd3Mub25tZXNzYWdlID0gKG0pIC0+XG4gICAgICAgIGlmIG0uZGF0YSBpbnN0YW5jZW9mIEFycmF5QnVmZmVyXG4gICAgICAgICAgY29uc29sZS5sb2cgJ2JpbmFyeSBtc2cnLCBtXG4gICAgICAgICRyb290U2NvcGUuJGFwcGx5IC0+XG4gICAgICAgICAgZGF0YSA9IEpTT04ucGFyc2UgbS5kYXRhXG4gICAgICAgICAgc3dpdGNoIHR5cGVvZiBkYXRhXG4gICAgICAgICAgICB3aGVuICdvYmplY3QnXG4gICAgICAgICAgICAgIGlmIEFycmF5LmlzQXJyYXkgZGF0YVxuICAgICAgICAgICAgICAgIHByb2Nlc3NScGNSZXBseSBkYXRhXG4gICAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICBmb3IgaywgdiBvZiBkYXRhXG4gICAgICAgICAgICAgICAgICBwcm9jZXNzTW9kZWxVcGRhdGUgaywgdlxuICAgICAgICAgICAgd2hlbiAnYm9vbGVhbidcbiAgICAgICAgICAgICAgaWYgZGF0YSAjIHJlbG9hZCBhcHBcbiAgICAgICAgICAgICAgICB3aW5kb3cubG9jYXRpb24ucmVsb2FkIHRydWVcbiAgICAgICAgICAgICAgZWxzZSAjIHJlZnJlc2ggc3R5bGVzaGVldHNcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyBcIkNTUyBSZWxvYWRcIlxuICAgICAgICAgICAgICAgIGZvciBlIGluIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lICdsaW5rJ1xuICAgICAgICAgICAgICAgICAgaWYgZS5ocmVmIGFuZCAvc3R5bGVzaGVldC9pLnRlc3QgZS5yZWxcbiAgICAgICAgICAgICAgICAgICAgZS5ocmVmID0gXCIje2UuaHJlZi5yZXBsYWNlIC9cXD8uKi8sICcnfT8je0RhdGUubm93KCl9XCJcbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgY29uc29sZS5sb2cgJ1NlcnZlciBtc2c6JywgZGF0YVxuXG4gICAgICAjIHdzLm9uZXJyb3IgPSAoZSkgLT5cbiAgICAgICMgICBjb25zb2xlLmxvZyAnRXJyb3InLCBlXG5cbiAgICAgIHdzLm9uY2xvc2UgPSAtPlxuICAgICAgICBjb25zb2xlLmxvZyAnV1MgTG9zdCdcbiAgICAgICAgJHJvb3RTY29wZS4kYXBwbHkgLT5cbiAgICAgICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QgJ3dzLWxvc3QnXG4gICAgICAgIHNldFRpbWVvdXQgcmVjb25uZWN0LCAxMDAwXG5cbiAgICByZWNvbm5lY3QgdHJ1ZVxuICAgXG4gICMgU2VuZCBhIHBheWxvYWQgdG8gdGhlIEplZUJ1cyBzZXJ2ZXIgb3ZlciB0aGUgd2Vic29ja2V0IGNvbm5lY3Rpb24uXG4gICMgVGhlIHBheWxvYWQgc2hvdWxkIGJlIGFuIG9iamVjdCAoYW55dGhpbmcgYnV0IGFycmF5IGlzIHN1cHBvcnRlZCBmb3Igbm93KS5cbiAgc2VuZCA9IChwYXlsb2FkKSAtPlxuICAgIHdzLnNlbmQgYW5ndWxhci50b0pzb24gcGF5bG9hZFxuICAgIEBcblxuICAjIEZldGNoIGEga2V5L3ZhbHVlIHBhaXIgZnJvbSB0aGUgc2VydmVyIGRhdGFiYXNlLCB2YWx1ZSByZXR1cm5lZCBhcyBwcm9taXNlLlxuICBnZXQgPSAoa2V5KSAtPlxuICAgIHJwYyAnZ2V0Jywga2V5XG4gICAgICBcbiAgIyBTdG9yZSBhIGtleS92YWx1ZSBwYWlyIGluIHRoZSBzZXJ2ZXIgZGF0YWJhc2UuXG4gIHB1dCA9IChrZXksIHZhbHVlKSAtPlxuICAgIHNlbmQgWzAsICdwdXQnLCBrZXksIHZhbHVlXVxuICAgIEBcbiAgICAgIFxuICAjIFBlcmZvcm0gYW4gUlBDIGNhbGwsIGkuZS4gcmVnaXN0ZXIgcmVzdWx0IGNhbGxiYWNrIGFuZCByZXR1cm4gYSBwcm9taXNlLlxuICBycGMgPSAoY21kLCBhcmdzLi4uKSAtPlxuICAgIGQgPSAkcS5kZWZlcigpXG4gICAgbiA9ICsrc2VxTnVtXG4gICAgd3Muc2VuZCBhbmd1bGFyLnRvSnNvbiBbY21kLCBuLCBhcmdzLi4uXVxuICAgIHQgPSBzZXRUaW1lb3V0IC0+XG4gICAgICBjb25zb2xlLmVycm9yIFwiUlBDICN7bn06IG5vIHJlcG9uc2VcIiwgYXJnc1xuICAgICAgZGVsZXRlIHJwY1Byb21pc2VzW25dXG4gICAgICAkcm9vdFNjb3BlLiRhcHBseSAtPlxuICAgICAgICBkLnJlamVjdCgpXG4gICAgLCAxMDAwMCAjIDEwIHNlY29uZHMgc2hvdWxkIGJlIGVub3VnaCB0byBjb21wbGV0ZSBhbnkgcmVxdWVzdFxuICAgIHJwY1Byb21pc2VzW25dID0gW3QsIGQsIG51bGxdXG4gICAgZC5wcm9taXNlXG5cbiAgIyBMYXVuY2ggYSBnYWRnZXQgb24gdGhlIHNlcnZlciBhbmQgcmV0dXJuIGl0cyByZXN1bHRzIHZpYSBldmVudHMuXG4gIGdhZGdldCA9IChhcmdzLi4uKSAtPlxuICAgIGUgPSBuZXcgRXZlbnRFbWl0dGVyXG4gICAgcnBjIGFyZ3MuLi5cbiAgICAgIC50aGVuIChlZVNldHRlcikgLT5cbiAgICAgICAgZWVTZXR0ZXIgZVxuICAgIGVcbiAgXG4gICMgQXR0YWNoLCBpLmUuIGdldCBjb3JyZXNwb25kaW5nIGRhdGEgYXMgYSBtb2RlbCB3aGljaCB0cmFja3MgYWxsIGNoYW5nZXMuXG4gIGF0dGFjaCA9IChwYXRoKSAtPlxuICAgIGluZm8gPSB0cmFja2VkTW9kZWxzW3BhdGhdID89IHsgbW9kZWw6IHt9LCBjb3VudDogMCB9XG4gICAgaWYgaW5mby5jb3VudCsrIGlzIDBcbiAgICAgIHJwYyAnYXR0YWNoJywgcGF0aFxuICAgICAgICAudGhlbiAocikgLT5cbiAgICAgICAgICBmb3IgaywgdiBvZiByXG4gICAgICAgICAgICBwcm9jZXNzTW9kZWxVcGRhdGUgaywgdlxuICAgICAgICAgIGNvbnNvbGUubG9nICdhdHRhY2gnLCBwYXRoXG4gICAgaW5mby5tb2RlbFxuXG4gICMgVW5kbyB0aGUgZWZmZWN0cyBvZiBhdHRhY2hpbmcsIGkuZS4gc3RvcCBmb2xsb3dpbmcgY2hhbmdlcy5cbiAgZGV0YWNoID0gKHBhdGgpIC0+XG4gICAgaWYgdHJhY2tlZE1vZGVsc1twYXRoXSAmJiAtLXRyYWNrZWRNb2RlbHNbcGF0aF0uY291bnQgPD0gMFxuICAgICAgZGVsZXRlIHRyYWNrZWRNb2RlbHNbcGF0aF1cbiAgICAgIHJwYyAnZGV0YWNoJywgcGF0aFxuICAgICAgICAudGhlbiAtPiBjb25zb2xlLmxvZyAnZGV0YWNoJywgcGF0aFxuICAgIEBcblxuICB3aW5kb3cuc2VuZCA9IHNlbmQgIyBjb25zb2xlIGFjY2VzcywgZm9yIGRlYnVnZ2luZ1xuICB7Y29ubmVjdCxzZW5kLGdldCxwdXQscnBjLGdhZGdldCxhdHRhY2gsZGV0YWNofVxuIl19
