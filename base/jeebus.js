(function() {
  var ng,
    __slice = [].slice;

  ng = angular.module('myApp');

  ng.factory('jeebus', function($rootScope, $q) {
    var attach, connect, detach, processModelUpdate, processRpcReply, rpc, rpcPromises, send, seqNum, store, trackedModels, ws;
    ws = null;
    seqNum = 0;
    rpcPromises = {};
    trackedModels = {};
    processModelUpdate = function(key, value) {
      var info, k, suffix;
      for (k in trackedModels) {
        info = trackedModels[k];
        if (k === key.slice(0, k.length)) {
          suffix = key.slice(k.length);
          if (value) {
            info.model[suffix] = value;
          } else {
            delete info.model[suffix];
          }
        }
      }
      if (!suffix) {
        return console.error("spurious model update", key, value);
      }
    };
    processRpcReply = function(n, result, err) {
      var d, tid, _ref;
      if (rpcPromises[n]) {
        _ref = rpcPromises[n], tid = _ref[0], d = _ref[1];
        clearTimeout(tid);
        if (err) {
          console.error(err);
          return d.reject(err);
        } else {
          return d.resolve(result);
        }
      } else {
        return console.error("spurious rpc reply", n, result, err);
      }
    };
    connect = function(appTag, port) {
      var reconnect;
      if (port == null) {
        port = location.port;
      }
      reconnect = function(firstCall) {
        ws = new WebSocket("ws://" + location.hostname + ":" + port + "/ws", [appTag]);
        ws.onopen = function() {
          return console.log('WS Open');
        };
        ws.onmessage = function(m) {
          if (m.data instanceof ArrayBuffer) {
            console.log('binary msg', m);
          }
          return $rootScope.$apply(function() {
            var data, k, v, _results;
            data = JSON.parse(m.data);
            if (m.data[0] === '[') {
              return processRpcReply.apply(null, data);
            } else {
              _results = [];
              for (k in data) {
                v = data[k];
                _results.push(processModelUpdate(k, v));
              }
              return _results;
            }
          });
        };
        return ws.onclose = function() {
          console.log('WS Closed');
          return setTimeout(reconnect, 1000);
        };
      };
      return reconnect(true);
    };
    send = function(payload) {
      var msg;
      msg = angular.toJson(payload);
      if (msg[0] === '[') {
        console.error("payload can't be an array (" + payload.length + " elements)");
      } else {
        ws.send(msg);
      }
      return this;
    };
    store = function(key, value) {
      var msg;
      msg = angular.toJson([key, value]);
      if (msg.slice(0, 3) === '["/') {
        ws.send(msg);
      } else {
        console.error('key does not start with "/":', key);
      }
      return this;
    };
    rpc = function() {
      var args, d, n, tid;
      args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
      d = $q.defer();
      n = ++seqNum;
      ws.send(angular.toJson([n].concat(__slice.call(args))));
      tid = setTimeout(function() {
        console.error("RPC " + n + ": no reponse", args);
        delete rpcPromises[n];
        return $rootScope.$apply(function() {
          return d.reject();
        });
      }, 10000);
      rpcPromises[n] = [tid, d];
      return d.promise;
    };
    attach = function(path) {
      var info;
      info = trackedModels[path] != null ? trackedModels[path] : trackedModels[path] = {
        model: {},
        count: 0
      };
      if (info.count++ === 0) {
        rpc('attach', path).then(function(r) {
          var k, v;
          for (k in r) {
            v = r[k];
            processModelUpdate(k, v);
          }
          return console.log('attach', path);
        });
      }
      return info.model;
    };
    detach = function(path) {
      if (trackedModels[path] && --trackedModels[path].count <= 0) {
        delete trackedModels[path];
        return rpc('detach', path).then(function() {
          return console.log('detach', path);
        });
      }
    };
    return {
      connect: connect,
      send: send,
      store: store,
      rpc: rpc,
      attach: attach,
      detach: detach
    };
  });

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiamVlYnVzLmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUFBLE1BQUEsRUFBQTtJQUFBLGtCQUFBOztBQUFBLEVBQUEsRUFBQSxHQUFLLE9BQU8sQ0FBQyxNQUFSLENBQWUsT0FBZixDQUFMLENBQUE7O0FBQUEsRUFJQSxFQUFFLENBQUMsT0FBSCxDQUFXLFFBQVgsRUFBcUIsU0FBQyxVQUFELEVBQWEsRUFBYixHQUFBO0FBQ25CLFFBQUEsc0hBQUE7QUFBQSxJQUFBLEVBQUEsR0FBSyxJQUFMLENBQUE7QUFBQSxJQUNBLE1BQUEsR0FBUyxDQURULENBQUE7QUFBQSxJQUVBLFdBQUEsR0FBYyxFQUZkLENBQUE7QUFBQSxJQUdBLGFBQUEsR0FBZ0IsRUFIaEIsQ0FBQTtBQUFBLElBTUEsa0JBQUEsR0FBcUIsU0FBQyxHQUFELEVBQU0sS0FBTixHQUFBO0FBQ25CLFVBQUEsZUFBQTtBQUFBLFdBQUEsa0JBQUE7Z0NBQUE7QUFDRSxRQUFBLElBQUcsQ0FBQSxLQUFLLEdBQUcsQ0FBQyxLQUFKLENBQVUsQ0FBVixFQUFhLENBQUMsQ0FBQyxNQUFmLENBQVI7QUFDRSxVQUFBLE1BQUEsR0FBUyxHQUFHLENBQUMsS0FBSixDQUFVLENBQUMsQ0FBQyxNQUFaLENBQVQsQ0FBQTtBQUNBLFVBQUEsSUFBRyxLQUFIO0FBQ0UsWUFBQSxJQUFJLENBQUMsS0FBTSxDQUFBLE1BQUEsQ0FBWCxHQUFxQixLQUFyQixDQURGO1dBQUEsTUFBQTtBQUdFLFlBQUEsTUFBQSxDQUFBLElBQVcsQ0FBQyxLQUFNLENBQUEsTUFBQSxDQUFsQixDQUhGO1dBRkY7U0FERjtBQUFBLE9BQUE7QUFPQSxNQUFBLElBQUEsQ0FBQSxNQUFBO2VBQUEsT0FBTyxDQUFDLEtBQVIsQ0FBYyx1QkFBZCxFQUF1QyxHQUF2QyxFQUE0QyxLQUE1QyxFQUFBO09BUm1CO0lBQUEsQ0FOckIsQ0FBQTtBQUFBLElBaUJBLGVBQUEsR0FBa0Is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QVMsTUFBQSxJQUFUO0FBQUEsTUFBYyxPQUFBLEtBQWQ7QUFBQSxNQUFvQixLQUFBLEdBQXBCO0FBQUEsTUFBd0IsUUFBQSxNQUF4QjtBQUFBLE1BQStCLFFBQUEsTUFBL0I7TUF2SG1CO0VBQUEsQ0FBckIsQ0FKQSxDQUFBO0FBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJuZyA9IGFuZ3VsYXIubW9kdWxlICdteUFwcCdcblxuIyBUaGUgXCJqZWVidXNcIiBzZXJ2aWNlIGJlbG93IGlzIHRoZSBzYW1lIGZvciBhbGwgY2xpZW50LXNpZGUgYXBwbGljYXRpb25zLlxuIyBJdCBsZXRzIGFuZ3VsYXIgY29ubmVjdCB0byB0aGUgSmVlQnVzIHNlcnZlciBhbmQgc2VuZC9yZWNlaXZlIG1lc3NhZ2VzLlxubmcuZmFjdG9yeSAnamVlYnVzJywgKCRyb290U2NvcGUsICRxKSAtPlxuICB3cyA9IG51bGwgICAgICAgICAgIyB0aGUgd2Vic29ja2V0IG9iamVjdCwgd2hpbGUgb3BlblxuICBzZXFOdW0gPSAwICAgICAgICAgIyB1bmlxdWUgc2VxdWVuY2UgbnVtYmVycyBmb3IgZWFjaCBSUEMgcmVxdWVzdFxuICBycGNQcm9taXNlcyA9IHt9ICAgIyBtYXBzIHNlcU51bSB0byBhIHBlbmRpbmcgPHRpbWVySWQscHJvbWlzZT4gZW50cnlcbiAgdHJhY2tlZE1vZGVscyA9IHt9ICMga2VlcHMgdHJhY2sgb2Ygd2hpY2ggcGF0aHMgaGF2ZSBiZWVuIGF0dGFjaGVkXG5cbiAgIyBVcGRhdGUgb25lIG9yIG1vcmUgb2YgdGhlIHRyYWNrZWQgbW9kZWxzIHdpdGggYW4gaW5jb21pbmcgY2hhbmdlLlxuICBwcm9jZXNzTW9kZWxVcGRhdGUgPSAoa2V5LCB2YWx1ZSkgLT5cbiAgICBmb3IgaywgaW5mbyBvZiB0cmFja2VkTW9kZWxzXG4gICAgICBpZiBrIGlzIGtleS5zbGljZSgwLCBrLmxlbmd0aClcbiAgICAgICAgc3VmZml4ID0ga2V5LnNsaWNlKGsubGVuZ3RoKVxuICAgICAgICBpZiB2YWx1ZVxuICAgICAgICAgIGluZm8ubW9kZWxbc3VmZml4XSA9IHZhbHVlXG4gICAgICAgIGVsc2VcbiAgICAgICAgICBkZWxldGUgaW5mby5tb2RlbFtzdWZmaXhdXG4gICAgY29uc29sZS5lcnJvciBcInNwdXJpb3VzIG1vZGVsIHVwZGF0ZVwiLCBrZXksIHZhbHVlICB1bmxlc3Mgc3VmZml4XG5cbiAgIyBSZXNvbHZlIG9yIHJlamVjdCBhIHBlbmRpbmcgcnBjIHByb21pc2UuXG4gIHByb2Nlc3NScGNSZXBseSA9IChuLCByZXN1bHQsIGVycikgLT5cbiAgICBpZiBycGNQcm9taXNlc1tuXVxuICAgICAgW3RpZCxkXSA9IHJwY1Byb21pc2VzW25dXG4gICAgICBjbGVhclRpbWVvdXQgdGlkXG4gICAgICBpZiBlcnJcbiAgICAgICAgY29uc29sZS5lcnJvciBlcnJcbiAgICAgICAgZC5yZWplY3QgZXJyXG4gICAgICBlbHNlXG4gICAgICAgIGQucmVzb2x2ZSByZXN1bHRcbiAgICBlbHNlXG4gICAgICBjb25zb2xlLmVycm9yIFwic3B1cmlvdXMgcnBjIHJlcGx5XCIsIG4sIHJlc3VsdCwgZXJyXG5cbiAgIyBTZXQgdXAgYSB3ZWJzb2NrZXQgY29ubmVjdGlvbiB0byB0aGUgSmVlQnVzIHNlcnZlci5cbiAgIyBUaGUgYXBwVGFnIGlzIHRoZSBkZWZhdWx0IHRhZyB0byB1c2Ugd2hlbiBzZW5kaW5nIHJlcXVlc3RzIHRvIGl0LlxuICBjb25uZWN0ID0gKGFwcFRhZywgcG9ydCkgLT5cbiAgICBwb3J0ID89IGxvY2F0aW9uLnBvcnQgIyB0aGUgZGVmYXVsdCBwb3J0IGlzIHRoZSBzYW1lIGFzIHRoZSBIVFRQIHNlcnZlclxuXG4gICAgcmVjb25uZWN0ID0gKGZpcnN0Q2FsbCkgLT5cbiAgICAgICMgdGhlIHdlYnNvY2tldCBpcyBzZXJ2ZWQgZnJvbSB0aGUgc2FtZSBzaXRlIGFzIHRoZSB3ZWIgcGFnZVxuICAgICAgIyB3cyA9IG5ldyBXZWJTb2NrZXQgXCJ3czovLyN7bG9jYXRpb24uaG9zdH0vd3NcIlxuICAgICAgd3MgPSBuZXcgV2ViU29ja2V0IFwid3M6Ly8je2xvY2F0aW9uLmhvc3RuYW1lfToje3BvcnR9L3dzXCIsIFthcHBUYWddXG5cbiAgICAgIHdzLm9ub3BlbiA9IC0+XG4gICAgICAgICMgbG9jYXRpb24ucmVsb2FkKCkgIHVubGVzcyBmaXJzdENhbGxcbiAgICAgICAgY29uc29sZS5sb2cgJ1dTIE9wZW4nXG5cbiAgICAgIHdzLm9ubWVzc2FnZSA9IChtKSAtPlxuICAgICAgICBpZiBtLmRhdGEgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlclxuICAgICAgICAgIGNvbnNvbGUubG9nICdiaW5hcnkgbXNnJywgbVxuICAgICAgICAkcm9vdFNjb3BlLiRhcHBseSAtPlxuICAgICAgICAgIGRhdGEgPSBKU09OLnBhcnNlKG0uZGF0YSlcbiAgICAgICAgICBpZiBtLmRhdGFbMF0gaXMgJ1snXG4gICAgICAgICAgICBwcm9jZXNzUnBjUmVwbHkgZGF0YS4uLlxuICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICMgVE9ETzogc2hvdWxkIG5vdCB3cml0ZSBpbnRvIHRoZSByb290IHNjb3BlIChvciBtZXJnZSwgcGVyaGFwcz8pXG4gICAgICAgICAgICBmb3IgaywgdiBvZiBkYXRhXG4gICAgICAgICAgICAgICMgJHJvb3RTY29wZVtrXSA9IHZcbiAgICAgICAgICAgICAgcHJvY2Vzc01vZGVsVXBkYXRlIGssIHZcblxuICAgICAgIyB3cy5vbmVycm9yID0gKGUpIC0+XG4gICAgICAjICAgY29uc29sZS5sb2cgJ0Vycm9yJywgZVxuXG4gICAgICB3cy5vbmNsb3NlID0gLT5cbiAgICAgICAgY29uc29sZS5sb2cgJ1dTIENsb3NlZCdcbiAgICAgICAgc2V0VGltZW91dCByZWNvbm5lY3QsIDEwMDBcblxuICAgIHJlY29ubmVjdCB0cnVlXG4gICBcbiAgIyBTZW5kIGEgcGF5bG9hZCB0byB0aGUgSmVlQnVzIHNlcnZlciBvdmVyIHRoZSB3ZWJzb2NrZXQgY29ubmVjdGlvbi5cbiAgIyBUaGUgcGF5bG9hZCBzaG91bGQgYmUgYW4gb2JqZWN0IChhbnl0aGluZyBidXQgYXJyYXkgaXMgc3VwcG9ydGVkIGZvciBub3cpLlxuICAjIFRoaXMgYmVjb21lcyBhbiBNUVRUIG1lc3NhZ2Ugd2l0aCB0b3BpYyBcInN2LzxhcHBUYWc+L2lwLTxhZGRyOnBvcnQ+XCIuXG4gIHNlbmQgPSAocGF5bG9hZCkgLT5cbiAgICBtc2cgPSBhbmd1bGFyLnRvSnNvbiBwYXlsb2FkXG4gICAgaWYgbXNnWzBdIGlzICdbJ1xuICAgICAgY29uc29sZS5lcnJvciBcInBheWxvYWQgY2FuJ3QgYmUgYW4gYXJyYXkgKCN7cGF5bG9hZC5sZW5ndGh9IGVsZW1lbnRzKVwiXG4gICAgZWxzZVxuICAgICAgd3Muc2VuZCBtc2dcbiAgICBAXG5cbiAgIyBTdG9yZSBhIGtleS92YWx1ZSBwYWlyIGluIHRoZSBKZWVCdXMgZGF0YWJhc2UgKGtleSBtdXN0IHN0YXJ0IHdpdGggXCIvXCIpLlxuICBzdG9yZSA9IChrZXksIHZhbHVlKSAtPlxuICAgIG1zZyA9IGFuZ3VsYXIudG9Kc29uIFtrZXksIHZhbHVlXVxuICAgIGlmIG1zZy5zbGljZSgwLCAzKSBpcyAnW1wiLydcbiAgICAgIHdzLnNlbmQgbXNnXG4gICAgZWxzZVxuICAgICAgY29uc29sZS5lcnJvciAna2V5IGRvZXMgbm90IHN0YXJ0IHdpdGggXCIvXCI6Jywga2V5XG4gICAgQFxuICAgICAgXG4gICMgUGVyZm9ybSBhbiBSUEMgY2FsbCwgaS5lLiByZWdpc3RlciByZXN1bHQgY2FsbGJhY2sgYW5kIHJldHVybiBhIHByb21pc2UuXG4gICMgVGhpcyBkb2Vzbid0IHVzZSBNUVRUIHRvIGF2b2lkIGFkZGl0aW9uYWwgcm91bmQgdHJpcHMgZm9yIGZyZXF1ZW50IGNhbGxzLlxuICBycGMgPSAoYXJncy4uLikgLT5cbiAgICBkID0gJHEuZGVmZXIoKVxuICAgIG4gPSArK3NlcU51bVxuICAgIHdzLnNlbmQgYW5ndWxhci50b0pzb24gW24sIGFyZ3MuLi5dXG4gICAgdGlkID0gc2V0VGltZW91dCAtPlxuICAgICAgY29uc29sZS5lcnJvciBcIlJQQyAje259OiBubyByZXBvbnNlXCIsIGFyZ3NcbiAgICAgIGRlbGV0ZSBycGNQcm9taXNlc1tuXVxuICAgICAgJHJvb3RTY29wZS4kYXBwbHkgLT5cbiAgICAgICAgZC5yZWplY3QoKVxuICAgICwgMTAwMDAgIyAxMCBzZWNvbmRzIHNob3VsZCBiZSBlbm91Z2ggdG8gY29tcGxldGUgYW55IHJlcXVlc3RcbiAgICBycGNQcm9taXNlc1tuXSA9IFt0aWQsIGRdXG4gICAgZC5wcm9taXNlXG5cbiAgIyBBdHRhY2gsIGkuZS4gZ2V0IGNvcnJlc3BvbmRpbmcgZGF0YSBhcyBhIG1vZGVsIHdoaWNoIHRyYWNrcyBhbGwgY2hhbmdlcy5cbiAgYXR0YWNoID0gKHBhdGgpIC0+XG4gICAgaW5mbyA9IHRyYWNrZWRNb2RlbHNbcGF0aF0gPz0geyBtb2RlbDoge30sIGNvdW50OiAwIH1cbiAgICBpZiBpbmZvLmNvdW50KysgaXMgMFxuICAgICAgcnBjICdhdHRhY2gnLCBwYXRoXG4gICAgICAgIC50aGVuIChyKSAtPlxuICAgICAgICAgIGZvciBrLCB2IG9mIHJcbiAgICAgICAgICAgIHByb2Nlc3NNb2RlbFVwZGF0ZSBrLCB2XG4gICAgICAgICAgY29uc29sZS5sb2cgJ2F0dGFjaCcsIHBhdGhcbiAgICBpbmZvLm1vZGVsXG5cbiAgIyBVbmRvIHRoZSBlZmZlY3RzIG9mIGF0dGFjaGluZywgaS5lLiBzdG9wIGZvbGxvd2luZyBjaGFuZ2VzLlxuICBkZXRhY2ggPSAocGF0aCkgLT5cbiAgICBpZiB0cmFja2VkTW9kZWxzW3BhdGhdICYmIC0tdHJhY2tlZE1vZGVsc1twYXRoXS5jb3VudCA8PSAwXG4gICAgICBkZWxldGUgdHJhY2tlZE1vZGVsc1twYXRoXVxuICAgICAgcnBjICdkZXRhY2gnLCBwYXRoXG4gICAgICAgIC50aGVuIC0+IGNvbnNvbGUubG9nICdkZXRhY2gnLCBwYXRoXG5cbiAge2Nvbm5lY3Qsc2VuZCxzdG9yZSxycGMsYXR0YWNoLGRldGFjaH1cbiJdfQ==
