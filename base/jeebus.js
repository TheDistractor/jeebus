(function() {
  var ng,
    __slice = [].slice;

  ng = angular.module('myApp');

  console.log('NG', angular.version.full);

  ng.config(function($urlRouterProvider, $locationProvider) {
    $urlRouterProvider.otherwise('/');
    return $locationProvider.html5Mode(true);
  });

  ng.factory('jeebus', function($rootScope, $q) {
    var attach, connect, detach, get, processModelUpdate, processRpcReply, put, rpc, rpcPromises, send, seqNum, trackedModels, ws;
    ws = null;
    seqNum = 0;
    rpcPromises = {};
    trackedModels = {};
    processModelUpdate = function(key, value) {
      var info, k, suffix;
      for (k in trackedModels) {
        info = trackedModels[k];
        if (k === key.slice(0, k.length)) {
          suffix = key.slice(k.length);
          if (value) {
            info.model[suffix] = value;
          } else {
            delete info.model[suffix];
          }
        }
      }
      if (!suffix) {
        return console.error("spurious model update", key, value);
      }
    };
    processRpcReply = function(err, n, result) {
      var d, t, _ref;
      _ref = rpcPromises[n], t = _ref[0], d = _ref[1];
      if (d) {
        clearTimeout(t);
        if (err) {
          console.error(err);
          return d.reject(err);
        } else {
          return d.resolve(result);
        }
      } else {
        return console.error("spurious rpc reply", err, n, result);
      }
    };
    connect = function(appTag) {
      var reconnect;
      reconnect = function(firstCall) {
        ws = new WebSocket("ws://" + location.host + "/ws", [appTag]);
        ws.onopen = function() {
          console.log('WS Open');
          return $rootScope.$apply(function() {
            return $rootScope.serverStatus = 'connected';
          });
        };
        ws.onmessage = function(m) {
          if (m.data instanceof ArrayBuffer) {
            console.log('binary msg', m);
          }
          return $rootScope.$apply(function() {
            var data, e, k, v, _i, _len, _ref, _results, _results1;
            data = JSON.parse(m.data);
            switch (typeof data) {
              case 'object':
                if (Array.isArray(data)) {
                  return processRpcReply.apply(null, data);
                } else {
                  _results = [];
                  for (k in data) {
                    v = data[k];
                    _results.push(processModelUpdate(k, v));
                  }
                  return _results;
                }
                break;
              case 'boolean':
                if (data) {
                  return window.location.reload(true);
                } else {
                  console.log("CSS Reload");
                  _ref = document.getElementsByTagName('link');
                  _results1 = [];
                  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                    e = _ref[_i];
                    if (e.href && /stylesheet/i.test(e.rel)) {
                      _results1.push(e.href = "" + (e.href.replace(/\?.*/, '')) + "?" + (Date.now()));
                    } else {
                      _results1.push(void 0);
                    }
                  }
                  return _results1;
                }
                break;
              default:
                return console.log('Server msg:', data);
            }
          });
        };
        return ws.onclose = function() {
          console.log('WS Closed');
          $rootScope.$apply(function() {
            return $rootScope.serverStatus = 'disconnected';
          });
          return setTimeout(reconnect, 1000);
        };
      };
      return reconnect(true);
    };
    send = function(payload) {
      ws.send(angular.toJson(payload));
      return this;
    };
    get = function(key) {
      return rpc('get', key);
    };
    put = function(key, value) {
      send([0, 'put', key, value]);
      return this;
    };
    rpc = function() {
      var args, d, n, t;
      args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
      d = $q.defer();
      n = ++seqNum;
      ws.send(angular.toJson([n].concat(__slice.call(args))));
      t = setTimeout(function() {
        console.error("RPC " + n + ": no reponse", args);
        delete rpcPromises[n];
        return $rootScope.$apply(function() {
          return d.reject();
        });
      }, 10000);
      rpcPromises[n] = [t, d];
      return d.promise;
    };
    attach = function(path) {
      var info;
      info = trackedModels[path] != null ? trackedModels[path] : trackedModels[path] = {
        model: {},
        count: 0
      };
      if (info.count++ === 0) {
        rpc('attach', path).then(function(r) {
          var k, v;
          for (k in r) {
            v = r[k];
            processModelUpdate(k, v);
          }
          return console.log('attach', path);
        });
      }
      return info.model;
    };
    detach = function(path) {
      if (trackedModels[path] && --trackedModels[path].count <= 0) {
        delete trackedModels[path];
        rpc('detach', path).then(function() {
          return console.log('detach', path);
        });
      }
      return this;
    };
    window.send = send;
    return {
      connect: connect,
      send: send,
      get: get,
      put: put,
      rpc: rpc,
      attach: attach,
      detach: detach
    };
  });

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiamVlYnVzLmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUFBLE1BQUEsRUFBQTtJQUFBLGtCQUFBOztBQUFBLEVBQUEsRUFBQSxHQUFLLE9BQU8sQ0FBQyxNQUFSLENBQWUsT0FBZixDQUFMLENBQUE7O0FBQUEsRUFFQSxPQUFPLENBQUMsR0FBUixDQUFZLElBQVosRUFBa0IsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFsQyxDQUZBLENBQUE7O0FBQUEsRUFJQSxFQUFFLENBQUMsTUFBSCxDQUFVLFNBQUMsa0JBQUQsRUFBcUIsaUJBQXJCLEdBQUE7QUFDUixJQUFBLGtCQUFrQixDQUFDLFNBQW5CLENBQTZCLEdBQTdCLENBQUEsQ0FBQTtXQUNBLGlCQUFpQixDQUFDLFNBQWxCLENBQTRCLElBQTVCLEVBRlE7RUFBQSxDQUFWLENBSkEsQ0FBQTs7QUFBQSxFQVVBLEVBQUUsQ0FBQyxPQUFILENBQVcsUUFBWCxFQUFxQixTQUFDLFVBQUQsRUFBYSxFQUFiLEdBQUE7QUFDbkIsUUFBQSx5SEFBQTtBQUFBLElBQUEsRUFBQSxHQUFLLElBQUwsQ0FBQTtBQUFBLElBQ0EsTUFBQSxHQUFTLENBRFQsQ0FBQTtBQUFBLElBRUEsV0FBQSxHQUFjLEVBRmQsQ0FBQTtBQUFBLElBR0EsYUFBQSxHQUFnQixFQUhoQixDQUFBO0FBQUEsSUFNQSxrQkFBQSxHQUFxQixTQUFDLEdBQUQsRUFBTSxLQUFOLEdBQUE7QUFDbkIsVUFBQSxlQUFBO0FBQUEsV0FBQSxrQkFBQTtnQ0FBQTtBQUNFLFFBQUEsSUFBRyxDQUFBLEtBQUssR0FBRyxDQUFDLEtBQUosQ0FBVSxDQUFWLEVBQWEsQ0FBQyxDQUFDLE1BQWYsQ0FBUjtBQUNFLFVBQUEsTUFBQSxHQUFTLEdBQUcsQ0FBQyxLQUFKLENBQVUsQ0FBQyxDQUFDLE1BQVosQ0FBVCxDQUFBO0FBQ0EsVUFBQSxJQUFHLEtBQUg7QUFDRSxZQUFBLElBQUksQ0FBQyxLQUFN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IGFuZ3VsYXIudmVyc2lvbi5mdWxsXG5cbm5nLmNvbmZpZyAoJHVybFJvdXRlclByb3ZpZGVyLCAkbG9jYXRpb25Qcm92aWRlcikgLT5cbiAgJHVybFJvdXRlclByb3ZpZGVyLm90aGVyd2lzZSAnLydcbiAgJGxvY2F0aW9uUHJvdmlkZXIuaHRtbDVNb2RlIHRydWVcbiAgXG4jIFRoZSBcImplZWJ1c1wiIHNlcnZpY2UgYmVsb3cgaXMgdGhlIHNhbWUgZm9yIGFsbCBjbGllbnQtc2lkZSBhcHBsaWNhdGlvbnMuXG4jIEl0IGxldHMgYW5ndWxhciBjb25uZWN0IHRvIHRoZSBKZWVCdXMgc2VydmVyIGFuZCBzZW5kL3JlY2VpdmUgbWVzc2FnZXMuXG5uZy5mYWN0b3J5ICdqZWVidXMnLCAoJHJvb3RTY29wZSwgJHEpIC0+XG4gIHdzID0gbnVsbCAgICAgICAgICAjIHRoZSB3ZWJzb2NrZXQgb2JqZWN0LCB3aGlsZSBvcGVuXG4gIHNlcU51bSA9IDAgICAgICAgICAjIHVuaXF1ZSBzZXF1ZW5jZSBudW1iZXJzIGZvciBlYWNoIFJQQyByZXF1ZXN0XG4gIHJwY1Byb21pc2VzID0ge30gICAjIG1hcHMgc2VxTnVtIHRvIGEgcGVuZGluZyA8dGltZXJJZCxwcm9taXNlPiBlbnRyeVxuICB0cmFja2VkTW9kZWxzID0ge30gIyBrZWVwcyB0cmFjayBvZiB3aGljaCBwYXRocyBoYXZlIGJlZW4gYXR0YWNoZWRcblxuICAjIFVwZGF0ZSBvbmUgb3IgbW9yZSBvZiB0aGUgdHJhY2tlZCBtb2RlbHMgd2l0aCBhbiBpbmNvbWluZyBjaGFuZ2UuXG4gIHByb2Nlc3NNb2RlbFVwZGF0ZSA9IChrZXksIHZhbHVlKSAtPlxuICAgIGZvciBrLCBpbmZvIG9mIHRyYWNrZWRNb2RlbHNcbiAgICAgIGlmIGsgaXMga2V5LnNsaWNlKDAsIGsubGVuZ3RoKVxuICAgICAgICBzdWZmaXggPSBrZXkuc2xpY2Uoay5sZW5ndGgpXG4gICAgICAgIGlmIHZhbHVlXG4gICAgICAgICAgaW5mby5tb2RlbFtzdWZmaXhdID0gdmFsdWVcbiAgICAgICAgZWxzZVxuICAgICAgICAgIGRlbGV0ZSBpbmZvLm1vZGVsW3N1ZmZpeF1cbiAgICBjb25zb2xlLmVycm9yIFwic3B1cmlvdXMgbW9kZWwgdXBkYXRlXCIsIGtleSwgdmFsdWUgIHVubGVzcyBzdWZmaXhcblxuICAjIFJlc29sdmUgb3IgcmVqZWN0IGEgcGVuZGluZyBycGMgcHJvbWlzZS5cbiAgcHJvY2Vzc1JwY1JlcGx5ID0gKGVyciwgbiwgcmVzdWx0KSAtPlxuICAgIFt0LGRdID0gcnBjUHJvbWlzZXNbbl1cbiAgICBpZiBkXG4gICAgICBjbGVhclRpbWVvdXQgdFxuICAgICAgaWYgZXJyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IgZXJyXG4gICAgICAgIGQucmVqZWN0IGVyclxuICAgICAgZWxzZVxuICAgICAgICBkLnJlc29sdmUgcmVzdWx0XG4gICAgZWxzZVxuICAgICAgY29uc29sZS5lcnJvciBcInNwdXJpb3VzIHJwYyByZXBseVwiLCBlcnIsIG4sIHJlc3VsdFxuXG4gICMgU2V0IHVwIGEgd2Vic29ja2V0IGNvbm5lY3Rpb24gdG8gdGhlIEplZUJ1cyBzZXJ2ZXIuXG4gICMgVGhlIGFwcFRhZyBpcyB0aGUgZGVmYXVsdCB0YWcgdG8gdXNlIHdoZW4gc2VuZGluZyByZXF1ZXN0cyB0byBpdC5cbiAgY29ubmVjdCA9IChhcHBUYWcpIC0+XG5cbiAgICByZWNvbm5lY3QgPSAoZmlyc3RDYWxsKSAtPlxuICAgICAgIyB0aGUgd2Vic29ja2V0IGlzIHNlcnZlZCBmcm9tIHRoZSBzYW1lIHNpdGUgYXMgdGhlIHdlYiBwYWdlXG4gICAgICB3cyA9IG5ldyBXZWJTb2NrZXQgXCJ3czovLyN7bG9jYXRpb24uaG9zdH0vd3NcIiwgW2FwcFRhZ11cblxuICAgICAgd3Mub25vcGVuID0gLT5cbiAgICAgICAgIyBsb2NhdGlvbi5yZWxvYWQoKSAgdW5sZXNzIGZpcnN0Q2FsbFxuICAgICAgICBjb25zb2xlLmxvZyAnV1MgT3BlbidcbiAgICAgICAgJHJvb3RTY29wZS4kYXBwbHkgLT5cbiAgICAgICAgICAkcm9vdFNjb3BlLnNlcnZlclN0YXR1cyA9ICdjb25uZWN0ZWQnXG5cbiAgICAgIHdzLm9ubWVzc2FnZSA9IChtKSAtPlxuICAgICAgICBpZiBtLmRhdGEgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlclxuICAgICAgICAgIGNvbnNvbGUubG9nICdiaW5hcnkgbXNnJywgbVxuICAgICAgICAkcm9vdFNjb3BlLiRhcHBseSAtPlxuICAgICAgICAgIGRhdGEgPSBKU09OLnBhcnNlIG0uZGF0YVxuICAgICAgICAgIHN3aXRjaCB0eXBlb2YgZGF0YVxuICAgICAgICAgICAgd2hlbiAnb2JqZWN0J1xuICAgICAgICAgICAgICBpZiBBcnJheS5pc0FycmF5IGRhdGFcbiAgICAgICAgICAgICAgICBwcm9jZXNzUnBjUmVwbHkgZGF0YS4uLlxuICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgZm9yIGssIHYgb2YgZGF0YVxuICAgICAgICAgICAgICAgICAgcHJvY2Vzc01vZGVsVXBkYXRlIGssIHZcbiAgICAgICAgICAgIHdoZW4gJ2Jvb2xlYW4nXG4gICAgICAgICAgICAgIGlmIGRhdGEgIyByZWxvYWQgYXBwXG4gICAgICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uLnJlbG9hZCB0cnVlXG4gICAgICAgICAgICAgIGVsc2UgIyByZWZyZXNoIHN0eWxlc2hlZXRzXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2cgXCJDU1MgUmVsb2FkXCJcbiAgICAgICAgICAgICAgICBmb3IgZSBpbiBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSAnbGluaydcbiAgICAgICAgICAgICAgICAgIGlmIGUuaHJlZiBhbmQgL3N0eWxlc2hlZXQvaS50ZXN0IGUucmVsXG4gICAgICAgICAgICAgICAgICAgIGUuaHJlZiA9IFwiI3tlLmhyZWYucmVwbGFjZSAvXFw/LiovLCAnJ30/I3tEYXRlLm5vdygpfVwiXG4gICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nICdTZXJ2ZXIgbXNnOicsIGRhdGFcblxuICAgICAgIyB3cy5vbmVycm9yID0gKGUpIC0+XG4gICAgICAjICAgY29uc29sZS5sb2cgJ0Vycm9yJywgZVxuXG4gICAgICB3cy5vbmNsb3NlID0gLT5cbiAgICAgICAgY29uc29sZS5sb2cgJ1dTIENsb3NlZCdcbiAgICAgICAgJHJvb3RTY29wZS4kYXBwbHkgLT5cbiAgICAgICAgICAkcm9vdFNjb3BlLnNlcnZlclN0YXR1cyA9ICdkaXNjb25uZWN0ZWQnXG4gICAgICAgIHNldFRpbWVvdXQgcmVjb25uZWN0LCAxMDAwXG5cbiAgICByZWNvbm5lY3QgdHJ1ZVxuICAgXG4gICMgU2VuZCBhIHBheWxvYWQgdG8gdGhlIEplZUJ1cyBzZXJ2ZXIgb3ZlciB0aGUgd2Vic29ja2V0IGNvbm5lY3Rpb24uXG4gICMgVGhlIHBheWxvYWQgc2hvdWxkIGJlIGFuIG9iamVjdCAoYW55dGhpbmcgYnV0IGFycmF5IGlzIHN1cHBvcnRlZCBmb3Igbm93KS5cbiAgc2VuZCA9IChwYXlsb2FkKSAtPlxuICAgIHdzLnNlbmQgYW5ndWxhci50b0pzb24gcGF5bG9hZFxuICAgIEBcblxuICAjIEZldGNoIGEga2V5L3ZhbHVlIHBhaXIgZnJvbSB0aGUgc2VydmVyIGRhdGFiYXNlLCB2YWx1ZSByZXR1cm5lZCBhcyBwcm9taXNlLlxuICBnZXQgPSAoa2V5KSAtPlxuICAgIHJwYyAnZ2V0Jywga2V5XG4gICAgICBcbiAgIyBTdG9yZSBhIGtleS92YWx1ZSBwYWlyIGluIHRoZSBzZXJ2ZXIgZGF0YWJhc2UuXG4gIHB1dCA9IChrZXksIHZhbHVlKSAtPlxuICAgIHNlbmQgWzAsICdwdXQnLCBrZXksIHZhbHVlXVxuICAgIEBcbiAgICAgIFxuICAjIFBlcmZvcm0gYW4gUlBDIGNhbGwsIGkuZS4gcmVnaXN0ZXIgcmVzdWx0IGNhbGxiYWNrIGFuZCByZXR1cm4gYSBwcm9taXNlLlxuICBycGMgPSAoYXJncy4uLikgLT5cbiAgICBkID0gJHEuZGVmZXIoKVxuICAgIG4gPSArK3NlcU51bVxuICAgIHdzLnNlbmQgYW5ndWxhci50b0pzb24gW24sIGFyZ3MuLi5dXG4gICAgdCA9IHNldFRpbWVvdXQgLT5cbiAgICAgIGNvbnNvbGUuZXJyb3IgXCJSUEMgI3tufTogbm8gcmVwb25zZVwiLCBhcmdzXG4gICAgICBkZWxldGUgcnBjUHJvbWlzZXNbbl1cbiAgICAgICRyb290U2NvcGUuJGFwcGx5IC0+XG4gICAgICAgIGQucmVqZWN0KClcbiAgICAsIDEwMDAwICMgMTAgc2Vjb25kcyBzaG91bGQgYmUgZW5vdWdoIHRvIGNvbXBsZXRlIGFueSByZXF1ZXN0XG4gICAgcnBjUHJvbWlzZXNbbl0gPSBbdCwgZF1cbiAgICBkLnByb21pc2VcblxuICAjIEF0dGFjaCwgaS5lLiBnZXQgY29ycmVzcG9uZGluZyBkYXRhIGFzIGEgbW9kZWwgd2hpY2ggdHJhY2tzIGFsbCBjaGFuZ2VzLlxuICBhdHRhY2ggPSAocGF0aCkgLT5cbiAgICBpbmZvID0gdHJhY2tlZE1vZGVsc1twYXRoXSA/PSB7IG1vZGVsOiB7fSwgY291bnQ6IDAgfVxuICAgIGlmIGluZm8uY291bnQrKyBpcyAwXG4gICAgICBycGMgJ2F0dGFjaCcsIHBhdGhcbiAgICAgICAgLnRoZW4gKHIpIC0+XG4gICAgICAgICAgZm9yIGssIHYgb2YgclxuICAgICAgICAgICAgcHJvY2Vzc01vZGVsVXBkYXRlIGssIHZcbiAgICAgICAgICBjb25zb2xlLmxvZyAnYXR0YWNoJywgcGF0aFxuICAgIGluZm8ubW9kZWxcblxuICAjIFVuZG8gdGhlIGVmZmVjdHMgb2YgYXR0YWNoaW5nLCBpLmUuIHN0b3AgZm9sbG93aW5nIGNoYW5nZXMuXG4gIGRldGFjaCA9IChwYXRoKSAtPlxuICAgIGlmIHRyYWNrZWRNb2RlbHNbcGF0aF0gJiYgLS10cmFja2VkTW9kZWxzW3BhdGhdLmNvdW50IDw9IDBcbiAgICAgIGRlbGV0ZSB0cmFja2VkTW9kZWxzW3BhdGhdXG4gICAgICBycGMgJ2RldGFjaCcsIHBhdGhcbiAgICAgICAgLnRoZW4gLT4gY29uc29sZS5sb2cgJ2RldGFjaCcsIHBhdGhcbiAgICBAXG5cbiAgd2luZG93LnNlbmQgPSBzZW5kICMgY29uc29sZSBhY2Nlc3MsIGZvciBkZWJ1Z2dpbmdcbiAge2Nvbm5lY3Qsc2VuZCxnZXQscHV0LHJwYyxhdHRhY2gsZGV0YWNofVxuIl19
