(function() {
  var ng,
    __slice = [].slice;

  ng = angular.module('myApp');

  console.log('NG', angular.version.full);

  ng.config(function($urlRouterProvider, $locationProvider) {
    $urlRouterProvider.otherwise('/');
    return $locationProvider.html5Mode(true);
  });

  ng.factory('jeebus', function($rootScope, $q) {
    var attach, connect, detach, get, processModelUpdate, processRpcReply, put, rpc, rpcPromises, send, seqNum, trackedModels, ws;
    ws = null;
    seqNum = 0;
    rpcPromises = {};
    trackedModels = {};
    processModelUpdate = function(key, value) {
      var info, k, suffix;
      for (k in trackedModels) {
        info = trackedModels[k];
        if (k === key.slice(0, k.length)) {
          suffix = key.slice(k.length);
          if (value) {
            info.model[suffix] = value;
          } else {
            delete info.model[suffix];
          }
        }
      }
      if (!suffix) {
        return console.error("spurious model update", key, value);
      }
    };
    processRpcReply = function(err, n, result) {
      var d;
      d = rpcPromises[n];
      if (d) {
        if (err) {
          console.error(err);
          return d.reject(err);
        } else {
          return d.resolve(result);
        }
      } else {
        return console.error("spurious rpc reply", err, n, result);
      }
    };
    connect = function(appTag) {
      var reconnect;
      reconnect = function(firstCall) {
        ws = new WebSocket("ws://" + location.host + "/ws", [appTag]);
        ws.onopen = function() {
          console.log('WS Open');
          return $rootScope.$apply(function() {
            return $rootScope.serverStatus = 'connected';
          });
        };
        ws.onmessage = function(m) {
          if (m.data instanceof ArrayBuffer) {
            console.log('binary msg', m);
          }
          return $rootScope.$apply(function() {
            var data, e, k, v, _i, _len, _ref, _results, _results1;
            data = JSON.parse(m.data);
            switch (typeof data) {
              case 'object':
                if (Array.isArray(data)) {
                  return processRpcReply.apply(null, data);
                } else {
                  _results = [];
                  for (k in data) {
                    v = data[k];
                    _results.push(processModelUpdate(k, v));
                  }
                  return _results;
                }
                break;
              case 'boolean':
                if (data) {
                  return window.location.reload(true);
                } else {
                  console.log("CSS Reload");
                  _ref = document.getElementsByTagName('link');
                  _results1 = [];
                  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                    e = _ref[_i];
                    if (e.href && /stylesheet/i.test(e.rel)) {
                      _results1.push(e.href = "" + (e.href.replace(/\?.*/, '')) + "?" + (Date.now()));
                    } else {
                      _results1.push(void 0);
                    }
                  }
                  return _results1;
                }
                break;
              default:
                return console.log('Server msg:', data);
            }
          });
        };
        return ws.onclose = function() {
          console.log('WS Closed');
          $rootScope.$apply(function() {
            return $rootScope.serverStatus = 'disconnected';
          });
          return setTimeout(reconnect, 1000);
        };
      };
      return reconnect(true);
    };
    send = function(payload) {
      ws.send(angular.toJson(payload));
      return this;
    };
    get = function(key) {
      return rpc('get', key);
    };
    put = function(key, value) {
      send([0, 'put', key, value]);
      return this;
    };
    rpc = function() {
      var args, d, n;
      args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
      d = $q.defer();
      n = ++seqNum;
      rpcPromises[n] = d;
      ws.send(angular.toJson([n].concat(__slice.call(args))));
      setTimeout(function() {
        console.error("RPC " + n + ": no reponse", args);
        delete rpcPromises[n];
        return $rootScope.$apply(function() {
          return d.reject();
        });
      }, 10000);
      return d.promise;
    };
    attach = function(path) {
      var info;
      info = trackedModels[path] != null ? trackedModels[path] : trackedModels[path] = {
        model: {},
        count: 0
      };
      if (info.count++ === 0) {
        rpc('attach', path).then(function(r) {
          var k, v;
          for (k in r) {
            v = r[k];
            processModelUpdate(k, v);
          }
          return console.log('attach', path);
        });
      }
      return info.model;
    };
    detach = function(path) {
      if (trackedModels[path] && --trackedModels[path].count <= 0) {
        delete trackedModels[path];
        rpc('detach', path).then(function() {
          return console.log('detach', path);
        });
      }
      return this;
    };
    window.send = send;
    return {
      connect: connect,
      send: send,
      get: get,
      put: put,
      rpc: rpc,
      attach: attach,
      detach: detach
    };
  });

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiamVlYnVzLmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUFBLE1BQUEsRUFBQTtJQUFBLGtCQUFBOztBQUFBLEVBQUEsRUFBQSxHQUFLLE9BQU8sQ0FBQyxNQUFSLENBQWUsT0FBZixDQUFMLENBQUE7O0FBQUEsRUFFQSxPQUFPLENBQUMsR0FBUixDQUFZLElBQVosRUFBa0IsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFsQyxDQUZBLENBQUE7O0FBQUEsRUFJQSxFQUFFLENBQUMsTUFBSCxDQUFVLFNBQUMsa0JBQUQsRUFBcUIsaUJBQXJCLEdBQUE7QUFDUixJQUFBLGtCQUFrQixDQUFDLFNBQW5CLENBQTZCLEdBQTdCLENBQUEsQ0FBQTtXQUNBLGlCQUFpQixDQUFDLFNBQWxCLENBQTRCLElBQTVCLEVBRlE7RUFBQSxDQUFWLENBSkEsQ0FBQTs7QUFBQSxFQVVBLEVBQUUsQ0FBQyxPQUFILENBQVcsUUFBWCxFQUFxQixTQUFDLFVBQUQsRUFBYSxFQUFiLEdBQUE7QUFDbkIsUUFBQSx5SEFBQTtBQUFBLElBQUEsRUFBQSxHQUFLLElBQUwsQ0FBQTtBQUFBLElBQ0EsTUFBQSxHQUFTLENBRFQsQ0FBQTtBQUFBLElBRUEsV0FBQSxHQUFjLEVBRmQsQ0FBQTtBQUFBLElBR0EsYUFBQSxHQUFnQixFQUhoQixDQUFBO0FBQUEsSUFNQSxrQkFBQSxHQUFxQixTQUFDLEdBQUQsRUFBTSxLQUFOLEdBQUE7QUFDbkIsVUFBQSxlQUFBO0FBQUEsV0FBQSxrQkFBQTtnQ0FBQTtBQUNFLFFBQUEsSUFBRyxDQUFBLEtBQUssR0FBRyxDQUFDLEtBQUosQ0FBVSxDQUFWLEVBQWEsQ0FBQyxDQUFDLE1BQWYsQ0FBUjtBQUNFLFVBQUEsTUFBQSxHQUFTLEdBQUcsQ0FBQyxLQUFKLENBQVUsQ0FBQyxDQUFDLE1BQVosQ0FBVCxDQUFBO0FBQ0EsVUFBQSxJQUFHLEtBQUg7QUFDRSxZQUFBLElBQUksQ0FBQyxLQUFN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LGVBQUEsTUFBQTtxQkFBQTtBQUNFLFlBQUEsa0JBQUEsQ0FBbUIsQ0FBbkIsRUFBc0IsQ0FBdEIsQ0FBQSxDQURGO0FBQUEsV0FBQTtpQkFFQSxPQUFPLENBQUMsR0FBUixDQUFZLFFBQVosRUFBc0IsSUFBdEIsRUFISTtRQUFBLENBRFIsQ0FBQSxDQURGO09BREE7YUFPQSxJQUFJLENBQUMsTUFSRTtJQUFBLENBMUdULENBQUE7QUFBQSxJQXFIQSxNQUFBLEdBQVMsU0FBQyxJQUFELEdBQUE7QUFDUCxNQUFBLElBQUcsYUFBYyxDQUFBLElBQUEsQ0FBZCxJQUF1QixFQUFBLGFBQWdCLENBQUEsSUFBQSxDQUFLLENBQUMsS0FBdEIsSUFBK0IsQ0FBekQ7QUFDRSxRQUFBLE1BQUEsQ0FBQSxhQUFxQixDQUFBLElBQUEsQ0FBckIsQ0FBQTtBQUFBLFFBQ0EsR0FBQSxDQUFJLFFBQUosRUFBYyxJQUFkLENBQ0UsQ0FBQyxJQURILENBQ1EsU0FBQSxHQUFBO2lCQUFHLE9BQU8sQ0FBQyxHQUFSLENBQVksUUFBWixFQUFzQixJQUF0QixFQUFIO1FBQUEsQ0FEUixDQURBLENBREY7T0FBQTthQUlBLEtBTE87SUFBQSxDQXJIVCxDQUFBO0FBQUEsSUE0SEEsTUFBTSxDQUFDLElBQVAsR0FBYyxJQTVIZCxDQUFBO1dBNkhBO0FBQUEsTUFBQyxTQUFBLE9BQUQ7QUFBQSxNQUFTLE1BQUEsSUFBVDtBQUFBLE1BQWMsS0FBQSxHQUFkO0FBQUEsTUFBa0IsS0FBQSxHQUFsQjtBQUFBLE1BQXNCLEtBQUEsR0FBdEI7QUFBQSxNQUEwQixRQUFBLE1BQTFCO0FBQUEsTUFBaUMsUUFBQSxNQUFqQztNQTlIbUI7RUFBQSxDQUFyQixDQVZBLENBQUE7QUFBQSIsInNvdXJjZXNDb250ZW50IjpbIm5nID0gYW5ndWxhci5tb2R1bGUgJ215QXBwJ1xuXG5jb25zb2xlLmxvZyAnTkcnLCBhbmd1bGFyLnZlcnNpb24uZnVsbFxuXG5uZy5jb25maWcgKCR1cmxSb3V0ZXJQcm92aWRlciwgJGxvY2F0aW9uUHJvdmlkZXIpIC0+XG4gICR1cmxSb3V0ZXJQcm92aWRlci5vdGhlcndpc2UgJy8nXG4gICRsb2NhdGlvblByb3ZpZGVyLmh0bWw1TW9kZSB0cnVlXG4gIFxuIyBUaGUgXCJqZWVidXNcIiBzZXJ2aWNlIGJlbG93IGlzIHRoZSBzYW1lIGZvciBhbGwgY2xpZW50LXNpZGUgYXBwbGljYXRpb25zLlxuIyBJdCBsZXRzIGFuZ3VsYXIgY29ubmVjdCB0byB0aGUgSmVlQnVzIHNlcnZlciBhbmQgc2VuZC9yZWNlaXZlIG1lc3NhZ2VzLlxubmcuZmFjdG9yeSAnamVlYnVzJywgKCRyb290U2NvcGUsICRxKSAtPlxuICB3cyA9IG51bGwgICAgICAgICAgIyB0aGUgd2Vic29ja2V0IG9iamVjdCwgd2hpbGUgb3BlblxuICBzZXFOdW0gPSAwICAgICAgICAgIyB1bmlxdWUgc2VxdWVuY2UgbnVtYmVycyBmb3IgZWFjaCBSUEMgcmVxdWVzdFxuICBycGNQcm9taXNlcyA9IHt9ICAgIyBtYXBzIHNlcU51bSB0byBhIHBlbmRpbmcgPHRpbWVySWQscHJvbWlzZT4gZW50cnlcbiAgdHJhY2tlZE1vZGVscyA9IHt9ICMga2VlcHMgdHJhY2sgb2Ygd2hpY2ggcGF0aHMgaGF2ZSBiZWVuIGF0dGFjaGVkXG5cbiAgIyBVcGRhdGUgb25lIG9yIG1vcmUgb2YgdGhlIHRyYWNrZWQgbW9kZWxzIHdpdGggYW4gaW5jb21pbmcgY2hhbmdlLlxuICBwcm9jZXNzTW9kZWxVcGRhdGUgPSAoa2V5LCB2YWx1ZSkgLT5cbiAgICBmb3IgaywgaW5mbyBvZiB0cmFja2VkTW9kZWxzXG4gICAgICBpZiBrIGlzIGtleS5zbGljZSgwLCBrLmxlbmd0aClcbiAgICAgICAgc3VmZml4ID0ga2V5LnNsaWNlKGsubGVuZ3RoKVxuICAgICAgICBpZiB2YWx1ZVxuICAgICAgICAgIGluZm8ubW9kZWxbc3VmZml4XSA9IHZhbHVlXG4gICAgICAgIGVsc2VcbiAgICAgICAgICBkZWxldGUgaW5mby5tb2RlbFtzdWZmaXhdXG4gICAgY29uc29sZS5lcnJvciBcInNwdXJpb3VzIG1vZGVsIHVwZGF0ZVwiLCBrZXksIHZhbHVlICB1bmxlc3Mgc3VmZml4XG5cbiAgIyBSZXNvbHZlIG9yIHJlamVjdCBhIHBlbmRpbmcgcnBjIHByb21pc2UuXG4gIHByb2Nlc3NScGNSZXBseSA9IChlcnIsIG4sIHJlc3VsdCkgLT5cbiAgICBkID0gcnBjUHJvbWlzZXNbbl1cbiAgICBpZiBkXG4gICAgICBpZiBlcnJcbiAgICAgICAgY29uc29sZS5lcnJvciBlcnJcbiAgICAgICAgZC5yZWplY3QgZXJyXG4gICAgICBlbHNlXG4gICAgICAgIGQucmVzb2x2ZSByZXN1bHRcbiAgICBlbHNlXG4gICAgICBjb25zb2xlLmVycm9yIFwic3B1cmlvdXMgcnBjIHJlcGx5XCIsIGVyciwgbiwgcmVzdWx0XG5cbiAgIyBTZXQgdXAgYSB3ZWJzb2NrZXQgY29ubmVjdGlvbiB0byB0aGUgSmVlQnVzIHNlcnZlci5cbiAgIyBUaGUgYXBwVGFnIGlzIHRoZSBkZWZhdWx0IHRhZyB0byB1c2Ugd2hlbiBzZW5kaW5nIHJlcXVlc3RzIHRvIGl0LlxuICBjb25uZWN0ID0gKGFwcFRhZykgLT5cblxuICAgIHJlY29ubmVjdCA9IChmaXJzdENhbGwpIC0+XG4gICAgICAjIHRoZSB3ZWJzb2NrZXQgaXMgc2VydmVkIGZyb20gdGhlIHNhbWUgc2l0ZSBhcyB0aGUgd2ViIHBhZ2VcbiAgICAgIHdzID0gbmV3IFdlYlNvY2tldCBcIndzOi8vI3tsb2NhdGlvbi5ob3N0fS93c1wiLCBbYXBwVGFnXVxuXG4gICAgICB3cy5vbm9wZW4gPSAtPlxuICAgICAgICAjIGxvY2F0aW9uLnJlbG9hZCgpICB1bmxlc3MgZmlyc3RDYWxsXG4gICAgICAgIGNvbnNvbGUubG9nICdXUyBPcGVuJ1xuICAgICAgICAkcm9vdFNjb3BlLiRhcHBseSAtPlxuICAgICAgICAgICRyb290U2NvcGUuc2VydmVyU3RhdHVzID0gJ2Nvbm5lY3RlZCdcblxuICAgICAgd3Mub25tZXNzYWdlID0gKG0pIC0+XG4gICAgICAgIGlmIG0uZGF0YSBpbnN0YW5jZW9mIEFycmF5QnVmZmVyXG4gICAgICAgICAgY29uc29sZS5sb2cgJ2JpbmFyeSBtc2cnLCBtXG4gICAgICAgICRyb290U2NvcGUuJGFwcGx5IC0+XG4gICAgICAgICAgZGF0YSA9IEpTT04ucGFyc2UgbS5kYXRhXG4gICAgICAgICAgc3dpdGNoIHR5cGVvZiBkYXRhXG4gICAgICAgICAgICB3aGVuICdvYmplY3QnXG4gICAgICAgICAgICAgIGlmIEFycmF5LmlzQXJyYXkgZGF0YVxuICAgICAgICAgICAgICAgIHByb2Nlc3NScGNSZXBseSBkYXRhLi4uXG4gICAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICBmb3IgaywgdiBvZiBkYXRhXG4gICAgICAgICAgICAgICAgICBwcm9jZXNzTW9kZWxVcGRhdGUgaywgdlxuICAgICAgICAgICAgd2hlbiAnYm9vbGVhbidcbiAgICAgICAgICAgICAgaWYgZGF0YSAjIHJlbG9hZCBhcHBcbiAgICAgICAgICAgICAgICB3aW5kb3cubG9jYXRpb24ucmVsb2FkIHRydWVcbiAgICAgICAgICAgICAgZWxzZSAjIHJlZnJlc2ggc3R5bGVzaGVldHNcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyBcIkNTUyBSZWxvYWRcIlxuICAgICAgICAgICAgICAgIGZvciBlIGluIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lICdsaW5rJ1xuICAgICAgICAgICAgICAgICAgaWYgZS5ocmVmIGFuZCAvc3R5bGVzaGVldC9pLnRlc3QgZS5yZWxcbiAgICAgICAgICAgICAgICAgICAgZS5ocmVmID0gXCIje2UuaHJlZi5yZXBsYWNlIC9cXD8uKi8sICcnfT8je0RhdGUubm93KCl9XCJcbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgY29uc29sZS5sb2cgJ1NlcnZlciBtc2c6JywgZGF0YVxuXG4gICAgICAjIHdzLm9uZXJyb3IgPSAoZSkgLT5cbiAgICAgICMgICBjb25zb2xlLmxvZyAnRXJyb3InLCBlXG5cbiAgICAgIHdzLm9uY2xvc2UgPSAtPlxuICAgICAgICBjb25zb2xlLmxvZyAnV1MgQ2xvc2VkJ1xuICAgICAgICAkcm9vdFNjb3BlLiRhcHBseSAtPlxuICAgICAgICAgICRyb290U2NvcGUuc2VydmVyU3RhdHVzID0gJ2Rpc2Nvbm5lY3RlZCdcbiAgICAgICAgc2V0VGltZW91dCByZWNvbm5lY3QsIDEwMDBcblxuICAgIHJlY29ubmVjdCB0cnVlXG4gICBcbiAgIyBTZW5kIGEgcGF5bG9hZCB0byB0aGUgSmVlQnVzIHNlcnZlciBvdmVyIHRoZSB3ZWJzb2NrZXQgY29ubmVjdGlvbi5cbiAgIyBUaGUgcGF5bG9hZCBzaG91bGQgYmUgYW4gb2JqZWN0IChhbnl0aGluZyBidXQgYXJyYXkgaXMgc3VwcG9ydGVkIGZvciBub3cpLlxuICBzZW5kID0gKHBheWxvYWQpIC0+XG4gICAgd3Muc2VuZCBhbmd1bGFyLnRvSnNvbiBwYXlsb2FkXG4gICAgQFxuXG4gICMgRmV0Y2ggYSBrZXkvdmFsdWUgcGFpciBmcm9tIHRoZSBzZXJ2ZXIgZGF0YWJhc2UsIHZhbHVlIHJldHVybmVkIGFzIHByb21pc2UuXG4gIGdldCA9IChrZXkpIC0+XG4gICAgcnBjICdnZXQnLCBrZXlcbiAgICAgIFxuICAjIFN0b3JlIGEga2V5L3ZhbHVlIHBhaXIgaW4gdGhlIHNlcnZlciBkYXRhYmFzZS5cbiAgcHV0ID0gKGtleSwgdmFsdWUpIC0+XG4gICAgc2VuZCBbMCwgJ3B1dCcsIGtleSwgdmFsdWVdXG4gICAgQFxuICAgICAgXG4gICMgUGVyZm9ybSBhbiBSUEMgY2FsbCwgaS5lLiByZWdpc3RlciByZXN1bHQgY2FsbGJhY2sgYW5kIHJldHVybiBhIHByb21pc2UuXG4gIHJwYyA9IChhcmdzLi4uKSAtPlxuICAgIGQgPSAkcS5kZWZlcigpXG4gICAgbiA9ICsrc2VxTnVtXG4gICAgcnBjUHJvbWlzZXNbbl0gPSBkXG4gICAgd3Muc2VuZCBhbmd1bGFyLnRvSnNvbiBbbiwgYXJncy4uLl1cbiAgICBzZXRUaW1lb3V0IC0+XG4gICAgICBjb25zb2xlLmVycm9yIFwiUlBDICN7bn06IG5vIHJlcG9uc2VcIiwgYXJnc1xuICAgICAgZGVsZXRlIHJwY1Byb21pc2VzW25dXG4gICAgICAkcm9vdFNjb3BlLiRhcHBseSAtPlxuICAgICAgICBkLnJlamVjdCgpXG4gICAgLCAxMDAwMCAjIDEwIHNlY29uZHMgc2hvdWxkIGJlIGVub3VnaCB0byBjb21wbGV0ZSBhbnkgcmVxdWVzdFxuICAgIGQucHJvbWlzZVxuXG4gICMgQXR0YWNoLCBpLmUuIGdldCBjb3JyZXNwb25kaW5nIGRhdGEgYXMgYSBtb2RlbCB3aGljaCB0cmFja3MgYWxsIGNoYW5nZXMuXG4gIGF0dGFjaCA9IChwYXRoKSAtPlxuICAgIGluZm8gPSB0cmFja2VkTW9kZWxzW3BhdGhdID89IHsgbW9kZWw6IHt9LCBjb3VudDogMCB9XG4gICAgaWYgaW5mby5jb3VudCsrIGlzIDBcbiAgICAgIHJwYyAnYXR0YWNoJywgcGF0aFxuICAgICAgICAudGhlbiAocikgLT5cbiAgICAgICAgICBmb3IgaywgdiBvZiByXG4gICAgICAgICAgICBwcm9jZXNzTW9kZWxVcGRhdGUgaywgdlxuICAgICAgICAgIGNvbnNvbGUubG9nICdhdHRhY2gnLCBwYXRoXG4gICAgaW5mby5tb2RlbFxuXG4gICMgVW5kbyB0aGUgZWZmZWN0cyBvZiBhdHRhY2hpbmcsIGkuZS4gc3RvcCBmb2xsb3dpbmcgY2hhbmdlcy5cbiAgZGV0YWNoID0gKHBhdGgpIC0+XG4gICAgaWYgdHJhY2tlZE1vZGVsc1twYXRoXSAmJiAtLXRyYWNrZWRNb2RlbHNbcGF0aF0uY291bnQgPD0gMFxuICAgICAgZGVsZXRlIHRyYWNrZWRNb2RlbHNbcGF0aF1cbiAgICAgIHJwYyAnZGV0YWNoJywgcGF0aFxuICAgICAgICAudGhlbiAtPiBjb25zb2xlLmxvZyAnZGV0YWNoJywgcGF0aFxuICAgIEBcblxuICB3aW5kb3cuc2VuZCA9IHNlbmQgIyBjb25zb2xlIGFjY2VzcywgZm9yIGRlYnVnZ2luZ1xuICB7Y29ubmVjdCxzZW5kLGdldCxwdXQscnBjLGF0dGFjaCxkZXRhY2h9XG4iXX0=
