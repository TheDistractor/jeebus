(function() {
  var ng,
    __slice = [].slice;

  ng = angular.module('myApp');

  ng.config(function($urlRouterProvider, $locationProvider) {
    $urlRouterProvider.otherwise('/');
    return $locationProvider.html5Mode(true);
  });

  ng.factory('jeebus', function($rootScope, $q) {
    var attach, connect, detach, get, processModelUpdate, processRpcReply, put, rpc, rpcPromises, send, seqNum, trackedModels, ws;
    ws = null;
    seqNum = 0;
    rpcPromises = {};
    trackedModels = {};
    processModelUpdate = function(key, value) {
      var info, k, suffix;
      for (k in trackedModels) {
        info = trackedModels[k];
        if (k === key.slice(0, k.length)) {
          suffix = key.slice(k.length);
          if (value) {
            info.model[suffix] = value;
          } else {
            delete info.model[suffix];
          }
        }
      }
      if (!suffix) {
        return console.error("spurious model update", key, value);
      }
    };
    processRpcReply = function(err, n, result) {
      var d;
      d = rpcPromises[n];
      if (d) {
        if (err) {
          console.error(err);
          return d.reject(err);
        } else {
          return d.resolve(result);
        }
      } else {
        return console.error("spurious rpc reply", err, n, result);
      }
    };
    connect = function(appTag) {
      var reconnect;
      reconnect = function(firstCall) {
        ws = new WebSocket("ws://" + location.host + "/ws", [appTag]);
        ws.onopen = function() {
          console.log('WS Open');
          return $rootScope.$apply(function() {
            return $rootScope.serverStatus = 'connected';
          });
        };
        ws.onmessage = function(m) {
          if (m.data instanceof ArrayBuffer) {
            console.log('binary msg', m);
          }
          return $rootScope.$apply(function() {
            var data, e, k, v, _i, _len, _ref, _results, _results1;
            data = JSON.parse(m.data);
            switch (typeof data) {
              case 'object':
                if (Array.isArray(data)) {
                  return processRpcReply.apply(null, data);
                } else {
                  _results = [];
                  for (k in data) {
                    v = data[k];
                    _results.push(processModelUpdate(k, v));
                  }
                  return _results;
                }
                break;
              case 'boolean':
                if (data) {
                  return window.location.reload(true);
                } else {
                  console.log("CSS Reload");
                  _ref = document.getElementsByTagName('link');
                  _results1 = [];
                  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                    e = _ref[_i];
                    if (e.href && /stylesheet/i.test(e.rel)) {
                      _results1.push(e.href = "" + (e.href.replace(/\?.*/, '')) + "?" + (Date.now()));
                    } else {
                      _results1.push(void 0);
                    }
                  }
                  return _results1;
                }
                break;
              default:
                return console.log('Server msg:', data);
            }
          });
        };
        return ws.onclose = function() {
          console.log('WS Closed');
          $rootScope.$apply(function() {
            return $rootScope.serverStatus = 'disconnected';
          });
          return setTimeout(reconnect, 1000);
        };
      };
      return reconnect(true);
    };
    send = function(payload) {
      var msg;
      msg = angular.toJson(payload);
      if (msg[0] === '[') {
        console.error("payload can't be an array (" + payload.length + " elements)");
      } else {
        ws.send(msg);
      }
      return this;
    };
    get = function(key) {
      return rpc('get', key);
    };
    put = function(key, value) {
      ws.send(angular.toJson([0, 'put', key, value]));
      return this;
    };
    rpc = function() {
      var args, d, n;
      args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
      d = $q.defer();
      n = ++seqNum;
      rpcPromises[n] = d;
      ws.send(angular.toJson([n].concat(__slice.call(args))));
      setTimeout(function() {
        console.error("RPC " + n + ": no reponse", args);
        delete rpcPromises[n];
        return $rootScope.$apply(function() {
          return d.reject();
        });
      }, 10000);
      return d.promise;
    };
    attach = function(path) {
      var info;
      info = trackedModels[path] != null ? trackedModels[path] : trackedModels[path] = {
        model: {},
        count: 0
      };
      if (info.count++ === 0) {
        rpc('attach', path).then(function(r) {
          var k, v;
          for (k in r) {
            v = r[k];
            processModelUpdate(k, v);
          }
          return console.log('attach', path);
        });
      }
      return info.model;
    };
    detach = function(path) {
      if (trackedModels[path] && --trackedModels[path].count <= 0) {
        delete trackedModels[path];
        rpc('detach', path).then(function() {
          return console.log('detach', path);
        });
      }
      return this;
    };
    return {
      connect: connect,
      send: send,
      get: get,
      put: put,
      rpc: rpc,
      attach: attach,
      detach: detach
    };
  });

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiamVlYnVzLmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUFBLE1BQUEsRUFBQTtJQUFBLGtCQUFBOztBQUFBLEVBQUEsRUFBQSxHQUFLLE9BQU8sQ0FBQyxNQUFSLENBQWUsT0FBZixDQUFMLENBQUE7O0FBQUEsRUFFQSxFQUFFLENBQUMsTUFBSCxDQUFVLFNBQUMsa0JBQUQsRUFBcUIsaUJBQXJCLEdBQUE7QUFDUixJQUFBLGtCQUFrQixDQUFDLFNBQW5CLENBQTZCLEdBQTdCLENBQUEsQ0FBQTtXQUNBLGlCQUFpQixDQUFDLFNBQWxCLENBQTRCLElBQTVCLEVBRlE7RUFBQSxDQUFWLENBRkEsQ0FBQTs7QUFBQSxFQVFBLEVBQUUsQ0FBQyxPQUFILENBQVcsUUFBWCxFQUFxQixTQUFDLFVBQUQsRUFBYSxFQUFiLEdBQUE7QUFDbkIsUUFBQSx5SEFBQTtBQUFBLElBQUEsRUFBQSxHQUFLLElBQUwsQ0FBQTtBQUFBLElBQ0EsTUFBQSxHQUFTLENBRFQsQ0FBQTtBQUFBLElBRUEsV0FBQSxHQUFjLEVBRmQsQ0FBQTtBQUFBLElBR0EsYUFBQSxHQUFnQixFQUhoQixDQUFBO0FBQUEsSUFNQSxrQkFBQSxHQUFxQixTQUFDLEdBQUQsRUFBTSxLQUFOLEdBQUE7QUFDbkIsVUFBQSxlQUFBO0FBQUEsV0FBQSxrQkFBQTtnQ0FBQTtBQUNFLFFBQUEsSUFBRyxDQUFBLEtBQUssR0FBRyxDQUFDLEtBQUosQ0FBVSxDQUFWLEVBQWEsQ0FBQyxDQUFDLE1BQWYsQ0FBUjtBQUNFLFVBQUEsTUFBQSxHQUFTLEdBQUcsQ0FBQyxLQUFKLENBQVUsQ0FBQyxDQUFDLE1BQVosQ0FBVCxDQUFBO0FBQ0EsVUFBQSxJQUFHLEtBQUg7QUFDRSxZQUFBLElBQUksQ0FBQyxLQUFNLENBQUEsTUFBQSxDQUFYLEdBQXFCLEtBQXJCLENBREY7V0FBQSxNQUFBO0FBR0UsWUFBQSxNQUFBLENBQUEsSUFBVyxDQUFDLEtBQU0s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blxubmcuY29uZmlnICgkdXJsUm91dGVyUHJvdmlkZXIsICRsb2NhdGlvblByb3ZpZGVyKSAtPlxuICAkdXJsUm91dGVyUHJvdmlkZXIub3RoZXJ3aXNlICcvJ1xuICAkbG9jYXRpb25Qcm92aWRlci5odG1sNU1vZGUgdHJ1ZVxuICBcbiMgVGhlIFwiamVlYnVzXCIgc2VydmljZSBiZWxvdyBpcyB0aGUgc2FtZSBmb3IgYWxsIGNsaWVudC1zaWRlIGFwcGxpY2F0aW9ucy5cbiMgSXQgbGV0cyBhbmd1bGFyIGNvbm5lY3QgdG8gdGhlIEplZUJ1cyBzZXJ2ZXIgYW5kIHNlbmQvcmVjZWl2ZSBtZXNzYWdlcy5cbm5nLmZhY3RvcnkgJ2plZWJ1cycsICgkcm9vdFNjb3BlLCAkcSkgLT5cbiAgd3MgPSBudWxsICAgICAgICAgICMgdGhlIHdlYnNvY2tldCBvYmplY3QsIHdoaWxlIG9wZW5cbiAgc2VxTnVtID0gMCAgICAgICAgICMgdW5pcXVlIHNlcXVlbmNlIG51bWJlcnMgZm9yIGVhY2ggUlBDIHJlcXVlc3RcbiAgcnBjUHJvbWlzZXMgPSB7fSAgICMgbWFwcyBzZXFOdW0gdG8gYSBwZW5kaW5nIDx0aW1lcklkLHByb21pc2U+IGVudHJ5XG4gIHRyYWNrZWRNb2RlbHMgPSB7fSAjIGtlZXBzIHRyYWNrIG9mIHdoaWNoIHBhdGhzIGhhdmUgYmVlbiBhdHRhY2hlZFxuXG4gICMgVXBkYXRlIG9uZSBvciBtb3JlIG9mIHRoZSB0cmFja2VkIG1vZGVscyB3aXRoIGFuIGluY29taW5nIGNoYW5nZS5cbiAgcHJvY2Vzc01vZGVsVXBkYXRlID0gKGtleSwgdmFsdWUpIC0+XG4gICAgZm9yIGssIGluZm8gb2YgdHJhY2tlZE1vZGVsc1xuICAgICAgaWYgayBpcyBrZXkuc2xpY2UoMCwgay5sZW5ndGgpXG4gICAgICAgIHN1ZmZpeCA9IGtleS5zbGljZShrLmxlbmd0aClcbiAgICAgICAgaWYgdmFsdWVcbiAgICAgICAgICBpbmZvLm1vZGVsW3N1ZmZpeF0gPSB2YWx1ZVxuICAgICAgICBlbHNlXG4gICAgICAgICAgZGVsZXRlIGluZm8ubW9kZWxbc3VmZml4XVxuICAgIGNvbnNvbGUuZXJyb3IgXCJzcHVyaW91cyBtb2RlbCB1cGRhdGVcIiwga2V5LCB2YWx1ZSAgdW5sZXNzIHN1ZmZpeFxuXG4gICMgUmVzb2x2ZSBvciByZWplY3QgYSBwZW5kaW5nIHJwYyBwcm9taXNlLlxuICBwcm9jZXNzUnBjUmVwbHkgPSAoZXJyLCBuLCByZXN1bHQpIC0+XG4gICAgZCA9IHJwY1Byb21pc2VzW25dXG4gICAgaWYgZFxuICAgICAgaWYgZXJyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IgZXJyXG4gICAgICAgIGQucmVqZWN0IGVyclxuICAgICAgZWxzZVxuICAgICAgICBkLnJlc29sdmUgcmVzdWx0XG4gICAgZWxzZVxuICAgICAgY29uc29sZS5lcnJvciBcInNwdXJpb3VzIHJwYyByZXBseVwiLCBlcnIsIG4sIHJlc3VsdFxuXG4gICMgU2V0IHVwIGEgd2Vic29ja2V0IGNvbm5lY3Rpb24gdG8gdGhlIEplZUJ1cyBzZXJ2ZXIuXG4gICMgVGhlIGFwcFRhZyBpcyB0aGUgZGVmYXVsdCB0YWcgdG8gdXNlIHdoZW4gc2VuZGluZyByZXF1ZXN0cyB0byBpdC5cbiAgY29ubmVjdCA9IChhcHBUYWcpIC0+XG5cbiAgICByZWNvbm5lY3QgPSAoZmlyc3RDYWxsKSAtPlxuICAgICAgIyB0aGUgd2Vic29ja2V0IGlzIHNlcnZlZCBmcm9tIHRoZSBzYW1lIHNpdGUgYXMgdGhlIHdlYiBwYWdlXG4gICAgICB3cyA9IG5ldyBXZWJTb2NrZXQgXCJ3czovLyN7bG9jYXRpb24uaG9zdH0vd3NcIiwgW2FwcFRhZ11cblxuICAgICAgd3Mub25vcGVuID0gLT5cbiAgICAgICAgIyBsb2NhdGlvbi5yZWxvYWQoKSAgdW5sZXNzIGZpcnN0Q2FsbFxuICAgICAgICBjb25zb2xlLmxvZyAnV1MgT3BlbidcbiAgICAgICAgJHJvb3RTY29wZS4kYXBwbHkgLT5cbiAgICAgICAgICAkcm9vdFNjb3BlLnNlcnZlclN0YXR1cyA9ICdjb25uZWN0ZWQnXG5cbiAgICAgIHdzLm9ubWVzc2FnZSA9IChtKSAtPlxuICAgICAgICBpZiBtLmRhdGEgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlclxuICAgICAgICAgIGNvbnNvbGUubG9nICdiaW5hcnkgbXNnJywgbVxuICAgICAgICAkcm9vdFNjb3BlLiRhcHBseSAtPlxuICAgICAgICAgIGRhdGEgPSBKU09OLnBhcnNlKG0uZGF0YSlcbiAgICAgICAgICBzd2l0Y2ggdHlwZW9mIGRhdGFcbiAgICAgICAgICAgIHdoZW4gJ29iamVjdCdcbiAgICAgICAgICAgICAgaWYgQXJyYXkuaXNBcnJheSBkYXRhXG4gICAgICAgICAgICAgICAgcHJvY2Vzc1JwY1JlcGx5IGRhdGEuLi5cbiAgICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgIGZvciBrLCB2IG9mIGRhdGFcbiAgICAgICAgICAgICAgICAgIHByb2Nlc3NNb2RlbFVwZGF0ZSBrLCB2XG4gICAgICAgICAgICB3aGVuICdib29sZWFuJ1xuICAgICAgICAgICAgICBpZiBkYXRhICMgcmVsb2FkIGFwcFxuICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5yZWxvYWQgdHJ1ZVxuICAgICAgICAgICAgICBlbHNlICMgcmVmcmVzaCBzdHlsZXNoZWV0c1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nIFwiQ1NTIFJlbG9hZFwiXG4gICAgICAgICAgICAgICAgZm9yIGUgaW4gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgJ2xpbmsnXG4gICAgICAgICAgICAgICAgICBpZiBlLmhyZWYgYW5kIC9zdHlsZXNoZWV0L2kudGVzdCBlLnJlbFxuICAgICAgICAgICAgICAgICAgICBlLmhyZWYgPSBcIiN7ZS5ocmVmLnJlcGxhY2UgL1xcPy4qLywgJyd9PyN7RGF0ZS5ub3coKX1cIlxuICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICBjb25zb2xlLmxvZyAnU2VydmVyIG1zZzonLCBkYXRhXG5cbiAgICAgICMgd3Mub25lcnJvciA9IChlKSAtPlxuICAgICAgIyAgIGNvbnNvbGUubG9nICdFcnJvcicsIGVcblxuICAgICAgd3Mub25jbG9zZSA9IC0+XG4gICAgICAgIGNvbnNvbGUubG9nICdXUyBDbG9zZWQnXG4gICAgICAgICRyb290U2NvcGUuJGFwcGx5IC0+XG4gICAgICAgICAgJHJvb3RTY29wZS5zZXJ2ZXJTdGF0dXMgPSAnZGlzY29ubmVjdGVkJ1xuICAgICAgICBzZXRUaW1lb3V0IHJlY29ubmVjdCwgMTAwMFxuXG4gICAgcmVjb25uZWN0IHRydWVcbiAgIFxuICAjIFNlbmQgYSBwYXlsb2FkIHRvIHRoZSBKZWVCdXMgc2VydmVyIG92ZXIgdGhlIHdlYnNvY2tldCBjb25uZWN0aW9uLlxuICAjIFRoZSBwYXlsb2FkIHNob3VsZCBiZSBhbiBvYmplY3QgKGFueXRoaW5nIGJ1dCBhcnJheSBpcyBzdXBwb3J0ZWQgZm9yIG5vdykuXG4gIHNlbmQgPSAocGF5bG9hZCkgLT5cbiAgICBtc2cgPSBhbmd1bGFyLnRvSnNvbiBwYXlsb2FkXG4gICAgaWYgbXNnWzBdIGlzICdbJ1xuICAgICAgY29uc29sZS5lcnJvciBcInBheWxvYWQgY2FuJ3QgYmUgYW4gYXJyYXkgKCN7cGF5bG9hZC5sZW5ndGh9IGVsZW1lbnRzKVwiXG4gICAgZWxzZVxuICAgICAgd3Muc2VuZCBtc2dcbiAgICBAXG5cbiAgIyBGZXRjaCBhIGtleS92YWx1ZSBwYWlyIGZyb20gdGhlIHNlcnZlciBkYXRhYmFzZSwgdmFsdWUgcmV0dXJuZWQgYXMgcHJvbWlzZS5cbiAgZ2V0ID0gKGtleSkgLT5cbiAgICBycGMgJ2dldCcsIGtleVxuICAgICAgXG4gICMgU3RvcmUgYSBrZXkvdmFsdWUgcGFpciBpbiB0aGUgc2VydmVyIGRhdGFiYXNlLlxuICBwdXQgPSAoa2V5LCB2YWx1ZSkgLT5cbiAgICB3cy5zZW5kIGFuZ3VsYXIudG9Kc29uIFswLCAncHV0Jywga2V5LCB2YWx1ZV1cbiAgICBAXG4gICAgICBcbiAgIyBQZXJmb3JtIGFuIFJQQyBjYWxsLCBpLmUuIHJlZ2lzdGVyIHJlc3VsdCBjYWxsYmFjayBhbmQgcmV0dXJuIGEgcHJvbWlzZS5cbiAgcnBjID0gKGFyZ3MuLi4pIC0+XG4gICAgZCA9ICRxLmRlZmVyKClcbiAgICBuID0gKytzZXFOdW1cbiAgICBycGNQcm9taXNlc1tuXSA9IGRcbiAgICB3cy5zZW5kIGFuZ3VsYXIudG9Kc29uIFtuLCBhcmdzLi4uXVxuICAgIHNldFRpbWVvdXQgLT5cbiAgICAgIGNvbnNvbGUuZXJyb3IgXCJSUEMgI3tufTogbm8gcmVwb25zZVwiLCBhcmdzXG4gICAgICBkZWxldGUgcnBjUHJvbWlzZXNbbl1cbiAgICAgICRyb290U2NvcGUuJGFwcGx5IC0+XG4gICAgICAgIGQucmVqZWN0KClcbiAgICAsIDEwMDAwICMgMTAgc2Vjb25kcyBzaG91bGQgYmUgZW5vdWdoIHRvIGNvbXBsZXRlIGFueSByZXF1ZXN0XG4gICAgZC5wcm9taXNlXG5cbiAgIyBBdHRhY2gsIGkuZS4gZ2V0IGNvcnJlc3BvbmRpbmcgZGF0YSBhcyBhIG1vZGVsIHdoaWNoIHRyYWNrcyBhbGwgY2hhbmdlcy5cbiAgYXR0YWNoID0gKHBhdGgpIC0+XG4gICAgaW5mbyA9IHRyYWNrZWRNb2RlbHNbcGF0aF0gPz0geyBtb2RlbDoge30sIGNvdW50OiAwIH1cbiAgICBpZiBpbmZvLmNvdW50KysgaXMgMFxuICAgICAgcnBjICdhdHRhY2gnLCBwYXRoXG4gICAgICAgIC50aGVuIChyKSAtPlxuICAgICAgICAgIGZvciBrLCB2IG9mIHJcbiAgICAgICAgICAgIHByb2Nlc3NNb2RlbFVwZGF0ZSBrLCB2XG4gICAgICAgICAgY29uc29sZS5sb2cgJ2F0dGFjaCcsIHBhdGhcbiAgICBpbmZvLm1vZGVsXG5cbiAgIyBVbmRvIHRoZSBlZmZlY3RzIG9mIGF0dGFjaGluZywgaS5lLiBzdG9wIGZvbGxvd2luZyBjaGFuZ2VzLlxuICBkZXRhY2ggPSAocGF0aCkgLT5cbiAgICBpZiB0cmFja2VkTW9kZWxzW3BhdGhdICYmIC0tdHJhY2tlZE1vZGVsc1twYXRoXS5jb3VudCA8PSAwXG4gICAgICBkZWxldGUgdHJhY2tlZE1vZGVsc1twYXRoXVxuICAgICAgcnBjICdkZXRhY2gnLCBwYXRoXG4gICAgICAgIC50aGVuIC0+IGNvbnNvbGUubG9nICdkZXRhY2gnLCBwYXRoXG4gICAgQFxuXG4gIHtjb25uZWN0LHNlbmQsZ2V0LHB1dCxycGMsYXR0YWNoLGRldGFjaH1cbiJdfQ==
