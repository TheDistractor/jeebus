(function() {
  var findPin, ng, prepareData;

  ng = angular.module('myApp');

  ng.directive('circuitEditor', function() {
    return {
      restrict: 'E',
      scope: {
        defs: '=',
        data: '='
      },
      link: function(scope, elem, attr) {
        var diag, gadgetDrag, gadgets, lastg, redraw, svg, wires;
        svg = d3.select(elem[0]).append('svg').attr({
          height: "60%"
        });
        diag = d3.svg.diagonal().projection(function(d) {
          return [d.y, d.x];
        });
        lastg = gadgets = wires = null;
        gadgetDrag = d3.behavior.drag().origin(Object).on('dragstart', function(d) {
          this.parentNode.appendChild(this);
          return d3.event.sourceEvent.stopPropagation();
        }).on('drag', function(d) {
          d.x = d3.event.x | 0;
          d.y = d3.event.y | 0;
          d3.select(this).attr({
            transform: function(d) {
              return "translate(" + d.x + "," + d.y + ")";
            }
          });
          return wires.filter(function(w) {
            return w.source.g === d || w.target.g === d;
          }).each(function(d) {
            d.source = findPin(d.from, scope.data.gadgets);
            return d.target = findPin(d.to, scope.data.gadgets);
          }).attr({
            d: diag
          });
        }).on('dragend', function(d) {
          return console.log('save gadget', d);
        });
        redraw = function() {
          var g, p, pins;
          lastg = prepareData(scope.defs, scope.data);
          gadgets = svg.selectAll('.gadget').data(scope.data.gadgets, function(d) {
            return d.id;
          });
          wires = svg.selectAll('.wire').data(scope.data.wires);
          g = gadgets.enter().append('g').call(gadgetDrag).attr({
            "class": 'gadget'
          });
          g.append('rect').each(function(d) {
            d.def = scope.defs[d.type];
            d.hw = d.def.width / 2;
            d.hh = d.def.height / 2;
            return d3.select(this).attr({
              "class": 'outline',
              x: 0.5 - d.hw,
              y: 0.5 - d.hh,
              width: 2 * d.hw,
              height: 2 * d.hh
            });
          }).style({
            fill: function(d) {
              return d.def.shade;
            }
          });
          g.append('text').text(function(d) {
            return d.title;
          }).attr({
            "class": 'title',
            y: function(d) {
              return 12 - d.hh;
            }
          });
          g.append('text').text(function(d) {
            return d.def.name;
          }).attr({
            "class": 'type',
            y: function(d) {
              return -4 + d.hh;
            }
          });
          g.append('text').text(function(d) {
            return d.def.icon;
          }).attr({
            "class": 'iconfont',
            x: 0,
            y: 0
          });
          gadgets.exit().remove();
          pins = gadgets.selectAll('rect .pin').data(function(d) {
            return d.def.pins;
          });
          p = pins.enter();
          p.append('circle').attr({
            "class": 'pin',
            cx: (function(d) {
              return d.x + .5;
            }),
            cy: (function(d) {
              return d.y + .5;
            }),
            r: 3
          }).on('mousedown', function(d) {
            return console.log('c1', d);
          });
          p.append('text').text(function(d) {
            return d.name;
          }).attr({
            "class": function(d) {
              return d.dir;
            },
            x: function(d) {
              if (d.dir === 'in') {
                return d.x + 7;
              } else {
                return d.x - 7;
              }
            },
            y: function(d) {
              return d.y + 5;
            }
          });
          wires.enter().insert('path', 'g').attr({
            "class": 'wire',
            d: diag
          });
          wires.exit().remove();
          return gadgets.attr({
            transform: function(d) {
              return "translate(" + d.x + "," + d.y + ")";
            }
          });
        };
        redraw();
        return svg.on('mousedown', function() {
          var x, y, _ref;
          _ref = d3.mouse(this), x = _ref[0], y = _ref[1];
          scope.data.gadgets.push({
            id: "g" + (++lastg),
            x: x | 0,
            y: y | 0,
            title: 'Gadget Two',
            type: 'Pipe'
          });
          return redraw();
        });
      }
    };
  });

  findPin = function(name, gdata) {
    var g, gid, p, pname, _i, _j, _len, _len1, _ref, _ref1;
    _ref = name.split('.'), gid = _ref[0], pname = _ref[1];
    for (_i = 0, _len = gdata.length; _i < _len; _i++) {
      g = gdata[_i];
      if (gid === g.id) {
        _ref1 = g.def.pins;
        for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
          p = _ref1[_j];
          if (pname === p.name) {
            return {
              y: g.x + p.x + .5,
              x: g.y + p.y + .5,
              g: g,
              p: p
            };
          }
        }
      }
    }
  };

  prepareData = function(gdefs, gdata) {
    var d, ins, n, outs, p, seq, step, yIn, yOut, _i, _j, _k, _l, _len, _len1, _len2, _len3, _ref, _ref1, _ref2, _ref3;
    for (n in gdefs) {
      d = gdefs[n];
      d.name || (d.name = n);
      ins = 0;
      _ref = d.pins;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        p = _ref[_i];
        p.x = d.width / 2;
        if (p.dir === 'in') {
          p.x = -p.x;
          ++ins;
        }
      }
      outs = d.pins.length - ins;
      step = 16;
      yIn = -(ins - 1) * step / 2;
      yOut = -(outs - 1) * step / 2;
      _ref1 = d.pins;
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        p = _ref1[_j];
        if (p.dir === 'in') {
          p.y = yIn;
          yIn += step;
        } else {
          p.y = yOut;
          yOut += step;
        }
      }
      d.height = 30 + step * (ins > outs ? ins : outs);
    }
    seq = '';
    _ref2 = gdata.gadgets;
    for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
      d = _ref2[_k];
      if (d.id > seq) {
        seq = d.id;
      }
      d.def = gdefs[d.type];
      d.hw = d.def.width / 2;
      d.hh = d.def.height / 2;
    }
    _ref3 = gdata.wires;
    for (_l = 0, _len3 = _ref3.length; _l < _len3; _l++) {
      d = _ref3[_l];
      d.source = findPin(d.from, gdata.gadgets);
      d.target = findPin(d.to, gdata.gadgets);
    }
    return seq.slice(1) | 0;
  };

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY2lyY2VkaXQuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQUEsTUFBQSx3QkFBQTs7QUFBQSxFQUFBLEVBQUEsR0FBSyxPQUFPLENBQUMsTUFBUixDQUFlLE9BQWYsQ0FBTCxDQUFBOztBQUFBLEVBRUEsRUFBRSxDQUFDLFNBQUgsQ0FBYSxlQUFiLEVBQThCLFNBQUEsR0FBQTtXQUM1QjtBQUFBLE1BQUEsUUFBQSxFQUFVLEdBQVY7QUFBQSxNQUVBLEtBQUEsRUFDRTtBQUFBLFFBQUEsSUFBQSxFQUFNLEdBQU47QUFBQSxRQUNBLElBQUEsRUFBTSxHQUROO09BSEY7QUFBQSxNQU1BLElBQUEsRUFBTSxTQUFDLEtBQUQsRUFBUSxJQUFSLEVBQWMsSUFBZCxHQUFBO0FBQ0osWUFBQSxvREFBQTtBQUFBLFFBQUEsR0FBQSxHQUFNLEVBQUUsQ0FBQyxNQUFILENBQVUsSUFBSyxDQUFBLENBQUEsQ0FBZixDQUFrQixDQUFDLE1BQW5CLENBQTBCLEtBQTFCLENBQ0osQ0FBQyxJQURHLENBQ0U7QUFBQSxVQUFBLE1BQUEsRUFBUSxLQUFSO1NBREYsQ0FBTixDQUFBO0FBQUEsUUFFQSxJQUFBLEdBQU8sRUFBRSxDQUFDLEdBQUcsQ0FBQyxRQUFQLENBQUEsQ0FDTCxDQUFDLFVBREksQ0FDTyxTQUFDLENBQUQsR0FBQTtpQkFBTyxDQUFDLENBQUMsQ0FBQyxDQUFILEVBQU0sQ0FBQyxDQUFDLENBQVIsRUFBUDtRQUFBLENBRFAsQ0FGUCxDQUFBO0FBQUEsUUFLQSxLQUFBLEdBQVEsT0FBQSxHQUFVLEtBQUEsR0FBUSxJQUwxQixDQUFBO0FBQUEsUUFPQSxVQUFBLEdBQWEsRUFBRSxDQUFDLFFBQVEsQ0FBQyxJQUFaLENBQUEsQ0FDWCxDQUFDLE1BRFUsQ0FDSCxNQURHLENBRVgsQ0FBQyxFQUZVLENBRVAsV0FGTyxFQUVNLFNBQUMsQ0FBRCxHQUFBO0FBQ2YsVUFBQSxJQUFDLENBQUEsVUFBVSxD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O0FBQUEsTUFrQkEsQ0FBQyxDQUFDLE1BQUYsR0FBVyxFQUFBLEdBQUssSUFBQSxHQUFPLENBQUksR0FBQSxHQUFNLElBQVQsR0FBbUIsR0FBbkIsR0FBNEIsSUFBN0IsQ0FsQnZCLENBREY7QUFBQSxLQUFBO0FBQUEsSUFxQkEsR0FBQSxHQUFNLEVBckJOLENBQUE7QUFzQkE7QUFBQSxTQUFBLDhDQUFBO29CQUFBO0FBQ0UsTUFBQSxJQUFlLENBQUMsQ0FBQyxFQUFGLEdBQU8sR0FBdEI7QUFBQSxRQUFBLEdBQUEsR0FBTSxDQUFDLENBQUMsRUFBUixDQUFBO09BQUE7QUFBQSxNQUNBLENBQUMsQ0FBQyxHQUFGLEdBQVEsS0FBTSxDQUFBLENBQUMsQ0FBQyxJQUFGLENBRGQsQ0FBQTtBQUFBLE1BRUEsQ0FBQyxDQUFDLEVBQUYsR0FBTyxDQUFDLENBQUMsR0FBRyxDQUFDLEtBQU4sR0FBYyxDQUZyQixDQUFBO0FBQUEsTUFHQSxDQUFDLENBQUMsRUFBRixHQUFPLENBQUMsQ0FBQyxHQUFHLENBQUMsTUFBTixHQUFlLENBSHRCLENBREY7QUFBQSxLQXRCQTtBQTRCQTtBQUFBLFNBQUEsOENBQUE7b0JBQUE7QUFDRSxNQUFBLENBQUMsQ0FBQyxNQUFGLEdBQVcsT0FBQSxDQUFRLENBQUMsQ0FBQyxJQUFWLEVBQWdCLEtBQUssQ0FBQyxPQUF0QixDQUFYLENBQUE7QUFBQSxNQUNBLENBQUMsQ0FBQyxNQUFGLEdBQVcsT0FBQSxDQUFRLENBQUMsQ0FBQyxFQUFWLEVBQWMsS0FBSyxDQUFDLE9BQXBCLENBRFgsQ0FERjtBQUFBLEtBNUJBO0FBZ0NBLFdBQU8sR0FBRyxDQUFDLEtBQUosQ0FBVSxDQUFWLENBQUEsR0FBZSxDQUF0QixDQWxDWTtFQUFBLENBL0ZkLENBQUE7QUFBQSIsInNvdXJjZXNDb250ZW50IjpbIm5nID0gYW5ndWxhci5tb2R1bGUgJ215QXBwJ1xuXG5uZy5kaXJlY3RpdmUgJ2NpcmN1aXRFZGl0b3InLCAtPlxuICByZXN0cmljdDogJ0UnXG4gIFxuICBzY29wZTpcbiAgICBkZWZzOiAnPSdcbiAgICBkYXRhOiAnPSdcbiAgICBcbiAgbGluazogKHNjb3BlLCBlbGVtLCBhdHRyKSAtPiAgICBcbiAgICBzdmcgPSBkMy5zZWxlY3QoZWxlbVswXSkuYXBwZW5kICdzdmcnXG4gICAgICAuYXR0ciBoZWlnaHQ6IFwiNjAlXCJcbiAgICBkaWFnID0gZDMuc3ZnLmRpYWdvbmFsKClcbiAgICAgIC5wcm9qZWN0aW9uIChkKSAtPiBbZC55LCBkLnhdICMgdW5kbyB0aGUgeC95IHJldmVyc2FsIGZyb20gZmluZFBpblxuICAgIFxuICAgIGxhc3RnID0gZ2FkZ2V0cyA9IHdpcmVzID0gbnVsbFxuICAgIFxuICAgIGdhZGdldERyYWcgPSBkMy5iZWhhdmlvci5kcmFnKClcbiAgICAgIC5vcmlnaW4gT2JqZWN0XG4gICAgICAub24gJ2RyYWdzdGFydCcsIChkKSAtPlxuICAgICAgICBAcGFyZW50Tm9kZS5hcHBlbmRDaGlsZCBAICMgbW92ZSB0byBmcm9udFxuICAgICAgICBkMy5ldmVudC5zb3VyY2VFdmVudC5zdG9wUHJvcGFnYXRpb24oKVxuICAgICAgLm9uICdkcmFnJywgKGQpIC0+XG4gICAgICAgIGQueCA9IGQzLmV2ZW50LnggfCAwICMgc3RheSBvbiBpbnQgY29vcmRpbmF0ZXNcbiAgICAgICAgZC55ID0gZDMuZXZlbnQueSB8IDAgIyBzdGF5IG9uIGludCBjb29yZGluYXRlc1xuICAgICAgICBkMy5zZWxlY3QoQCkuYXR0ciB0cmFuc2Zvcm06IChkKSAtPiBcInRyYW5zbGF0ZSgje2QueH0sI3tkLnl9KVwiXG4gICAgICAgICMgcmVjYWxjdWxhdGUgZW5kcG9pbnRzIGFuZCByZWRyYXcgYWxsIHdpcmVzIGF0dGFjaGVkIHRvIHRoaXMgZ2FkZ2V0XG4gICAgICAgIHdpcmVzLmZpbHRlciAodykgLT4gdy5zb3VyY2UuZyBpcyBkIG9yIHcudGFyZ2V0LmcgaXMgZFxuICAgICAgICAgIC5lYWNoIChkKSAtPlxuICAgICAgICAgICAgZC5zb3VyY2UgPSBmaW5kUGluIGQuZnJvbSwgc2NvcGUuZGF0YS5nYWRnZXRzXG4gICAgICAgICAgICBkLnRhcmdldCA9IGZpbmRQaW4gZC50bywgc2NvcGUuZGF0YS5nYWRnZXRzXG4gICAgICAgICAgLmF0dHIgZDogZGlhZ1xuICAgICAgLm9uICdkcmFnZW5kJywgKGQpIC0+XG4gICAgICAgIGNvbnNvbGUubG9nICdzYXZlIGdhZGdldCcsIGQgIyBUT0RPOiBzYXZlIHRvIHNlcnZlclxuXG4gICAgcmVkcmF3ID0gLT5cbiAgICAgIGxhc3RnID0gcHJlcGFyZURhdGEgc2NvcGUuZGVmcywgc2NvcGUuZGF0YVxuICAgICAgZ2FkZ2V0cyA9IHN2Zy5zZWxlY3RBbGwoJy5nYWRnZXQnKS5kYXRhIHNjb3BlLmRhdGEuZ2FkZ2V0cywgKGQpIC0+IGQuaWRcbiAgICAgIHdpcmVzID0gc3ZnLnNlbGVjdEFsbCgnLndpcmUnKS5kYXRhIHNjb3BlLmRhdGEud2lyZXNcblxuICAgICAgZyA9IGdhZGdldHMuZW50ZXIoKS5hcHBlbmQoJ2cnKS5jYWxsKGdhZGdldERyYWcpXG4gICAgICAgIC5hdHRyIGNsYXNzOiAnZ2FkZ2V0J1xuICAgICAgZy5hcHBlbmQoJ3JlY3QnKVxuICAgICAgICAuZWFjaCAoZCkgLT5cbiAgICAgICAgICBkLmRlZiA9IHNjb3BlLmRlZnNbZC50eXBlXVxuICAgICAgICAgIGQuaHcgPSBkLmRlZi53aWR0aCAvIDJcbiAgICAgICAgICBkLmhoID0gZC5kZWYuaGVpZ2h0IC8gMlxuICAgICAgICAgIGQzLnNlbGVjdChAKS5hdHRyXG4gICAgICAgICAgICBjbGFzczogJ291dGxpbmUnXG4gICAgICAgICAgICAjIDFweCBsaW5lcyByZW5kZXIgc2hhcnBseSB3aGVuIG9uIGEgMC41cHggb2Zmc2V0XG4gICAgICAgICAgICB4OiAwLjUgLSBkLmh3LCB5OiAwLjUgLSBkLmhoXG4gICAgICAgICAgICB3aWR0aDogMiAqIGQuaHcsIGhlaWdodDogMiAqIGQuaGhcbiAgICAgICAgLnN0eWxlIGZpbGw6IChkKSAtPiBkLmRlZi5zaGFkZVxuICAgICAgZy5hcHBlbmQoJ3RleHQnKS50ZXh0IChkKSAtPiBkLnRpdGxlXG4gICAgICAgIC5hdHRyIGNsYXNzOiAndGl0bGUnLCB5OiAoZCkgLT4gMTIgLSBkLmhoXG4gICAgICBnLmFwcGVuZCgndGV4dCcpLnRleHQgKGQpIC0+IGQuZGVmLm5hbWVcbiAgICAgICAgLmF0dHIgY2xhc3M6ICd0eXBlJywgeTogKGQpIC0+IC00ICsgZC5oaFxuICAgICAgZy5hcHBlbmQoJ3RleHQnKS50ZXh0IChkKSAtPiBkLmRlZi5pY29uXG4gICAgICAgIC5hdHRyIGNsYXNzOiAnaWNvbmZvbnQnLCB4OiAwLCB5OiAwXG4gICAgICBnYWRnZXRzLmV4aXQoKS5yZW1vdmUoKVxuICAgICAgICBcbiAgICAgIHBpbnMgPSBnYWRnZXRzLnNlbGVjdEFsbCgncmVjdCAucGluJykuZGF0YSAoZCkgLT4gZC5kZWYucGluc1xuICAgICAgcCA9IHBpbnMuZW50ZXIoKVxuICAgICAgcC5hcHBlbmQoJ2NpcmNsZScpXG4gICAgICAgIC5hdHRyIGNsYXNzOiAncGluJywgY3g6ICgoZCkgLT4gZC54Ky41KSwgY3k6ICgoZCkgLT4gZC55Ky41KSwgcjogM1xuICAgICAgICAub24gJ21vdXNlZG93bicsIChkKSAtPlxuICAgICAgICAgIGNvbnNvbGUubG9nICdjMScsIGRcbiAgICAgIHAuYXBwZW5kKCd0ZXh0JykudGV4dCAoZCkgLT4gZC5uYW1lXG4gICAgICAgIC5hdHRyXG4gICAgICAgICAgY2xhc3M6IChkKSAtPiBkLmRpclxuICAgICAgICAgIHg6IChkKSAtPiBpZiBkLmRpciBpcyAnaW4nIHRoZW4gZC54ICsgNyBlbHNlIGQueCAtIDdcbiAgICAgICAgICB5OiAoZCkgLT4gZC55ICsgNVxuXG4gICAgICB3aXJlcy5lbnRlcigpLmluc2VydCgncGF0aCcsICdnJykgIyB1c2VzIGluc2VydCB0byBtb3ZlIHRvIGJhY2sgcmlnaHQgYXdheVxuICAgICAgICAuYXR0ciBjbGFzczogJ3dpcmUnLCBkOiBkaWFnXG4gICAgICB3aXJlcy5leGl0KCkucmVtb3ZlKClcblxuICAgICAgZ2FkZ2V0cy5hdHRyIHRyYW5zZm9ybTogKGQpIC0+IFwidHJhbnNsYXRlKCN7ZC54fSwje2QueX0pXCJcbiAgICBcbiAgICByZWRyYXcoKVxuICAgIFxuICAgIHN2Zy5vbiAnbW91c2Vkb3duJywgLT5cbiAgICAgICMgcmV0dXJuICBpZiBkMy5ldmVudC5kZWZhdWx0UHJldmVudGVkXG4gICAgICBbeCx5XSA9IGQzLm1vdXNlIEBcbiAgICAgIHNjb3BlLmRhdGEuZ2FkZ2V0cy5wdXNoXG4gICAgICAgIGlkOiBcImcjeysrbGFzdGd9XCIsIHg6IHh8MCwgeTogeXwwLCB0aXRsZTogJ0dhZGdldCBUd28nLCB0eXBlOiAnUGlwZSdcbiAgICAgIHJlZHJhdygpXG5cbmZpbmRQaW4gPSAobmFtZSwgZ2RhdGEpIC0+XG4gIFtnaWQscG5hbWVdID0gbmFtZS5zcGxpdCAnLidcbiAgZm9yIGcgaW4gZ2RhdGEgd2hlbiBnaWQgaXMgZy5pZFxuICAgIGZvciBwIGluIGcuZGVmLnBpbnMgd2hlbiBwbmFtZSBpcyBwLm5hbWVcbiAgICAgICMgcmV2ZXJzZXMgeCBhbmQgeSBhbmQgdXNlcyBwcm9qZWN0aW9uIHRvIGdldCBob3Jpem9udGFsIHNwbGluZXNcbiAgICAgIHJldHVybiB5OiBnLnggKyBwLnggKyAuNSwgeDogZy55ICsgcC55ICsgLjUsIGc6IGcsIHA6IHBcblxucHJlcGFyZURhdGEgPSAoZ2RlZnMsIGdkYXRhKSAtPlxuICAjIHByZS1jYWxjdWxhdGUgc2l6ZXMgYW5kIHJlbGF0aXZlIHBpbiBjb29yZGluYXRlc1xuICBmb3IgbiwgZCBvZiBnZGVmc1xuICAgIGQubmFtZSBvcj0gblxuICAgIGlucyA9IDBcbiAgICBmb3IgcCBpbiBkLnBpbnNcbiAgICAgIHAueCA9IGQud2lkdGggLyAyXG4gICAgICBpZiBwLmRpciBpcyAnaW4nXG4gICAgICAgIHAueCA9IC1wLnhcbiAgICAgICAgKytpbnNcbiAgICBvdXRzID0gZC5waW5zLmxlbmd0aCAtIGluc1xuICAgIHN0ZXAgPSAxNlxuICAgIHlJbiA9IC0gKGlucyAtIDEpICogc3RlcCAvIDJcbiAgICB5T3V0ID0gLSAob3V0cyAtIDEpICogc3RlcCAvIDJcbiAgICBmb3IgcCBpbiBkLnBpbnNcbiAgICAgIGlmIHAuZGlyIGlzICdpbidcbiAgICAgICAgcC55ID0geUluXG4gICAgICAgIHlJbiArPSBzdGVwXG4gICAgICBlbHNlXG4gICAgICAgIHAueSA9IHlPdXRcbiAgICAgICAgeU91dCArPSBzdGVwXG4gICAgZC5oZWlnaHQgPSAzMCArIHN0ZXAgKiAoaWYgaW5zID4gb3V0cyB0aGVuIGlucyBlbHNlIG91dHMpXG5cbiAgc2VxID0gJydcbiAgZm9yIGQgaW4gZ2RhdGEuZ2FkZ2V0c1xuICAgIHNlcSA9IGQuaWQgIGlmIGQuaWQgPiBzZXFcbiAgICBkLmRlZiA9IGdkZWZzW2QudHlwZV1cbiAgICBkLmh3ID0gZC5kZWYud2lkdGggLyAyXG4gICAgZC5oaCA9IGQuZGVmLmhlaWdodCAvIDJcblxuICBmb3IgZCBpbiBnZGF0YS53aXJlc1xuICAgIGQuc291cmNlID0gZmluZFBpbiBkLmZyb20sIGdkYXRhLmdhZGdldHNcbiAgICBkLnRhcmdldCA9IGZpbmRQaW4gZC50bywgZ2RhdGEuZ2FkZ2V0c1xuICAgIFxuICByZXR1cm4gc2VxLnNsaWNlKDEpIHwgMCAjIGRyb3AgdGhlIGxlYWRpbmcgXCJnXCIsIHJldHVybiBhcyBpbnRcbiJdfQ==
