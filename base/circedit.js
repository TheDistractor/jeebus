(function() {
  var findPin, ng, prepareData;

  ng = angular.module('myApp');

  ng.directive('circuitEditor', function() {
    return {
      restrict: 'E',
      scope: {
        defs: '=',
        data: '='
      },
      link: function(scope, elem, attr) {
        var diag, g, gadgetDrag, gadgets, p, pins, svg, wires;
        prepareData(scope.defs, scope.data);
        svg = d3.select(elem[0]).append('svg').attr({
          height: "60%"
        });
        gadgets = svg.selectAll('.gadget').data(scope.data.gadgets, function(d) {
          return d.id;
        });
        wires = svg.selectAll('.wire').data(scope.data.wires);
        diag = d3.svg.diagonal().projection(function(d) {
          return [d.y, d.x];
        });
        gadgetDrag = d3.behavior.drag().origin(Object).on('dragstart', function(d) {
          this.parentNode.appendChild(this);
          return d3.event.sourceEvent.stopPropagation();
        }).on('drag', function(d) {
          d.x = d3.event.x | 0;
          d.y = d3.event.y | 0;
          d3.select(this).attr({
            transform: function(d) {
              return "translate(" + d.x + "," + d.y + ")";
            }
          });
          return wires.filter(function(w) {
            return w.source.g === d || w.target.g === d;
          }).each(function(d) {
            d.source = findPin(d.from, scope.data.gadgets);
            return d.target = findPin(d.to, scope.data.gadgets);
          }).attr({
            d: diag
          });
        }).on('dragend', function(d) {
          return console.log('save gadget', d);
        });
        g = gadgets.enter().append('g').call(gadgetDrag).attr({
          "class": 'gadget'
        });
        g.append('rect').each(function(d) {
          return d3.select(this).attr({
            "class": 'outline',
            x: 0.5 - d.hw,
            y: 0.5 - d.hh,
            width: 2 * d.hw,
            height: 2 * d.hh
          });
        }).style({
          fill: function(d) {
            return d.def.shade;
          }
        });
        g.append('text').text(function(d) {
          return d.title;
        }).attr({
          "class": 'title',
          y: function(d) {
            return 12 - d.hh;
          }
        });
        g.append('text').text(function(d) {
          return d.def.name;
        }).attr({
          "class": 'type',
          y: function(d) {
            return -4 + d.hh;
          }
        });
        g.append('text').text(function(d) {
          return d.def.icon;
        }).attr({
          "class": 'iconfont',
          x: 0,
          y: 0
        });
        gadgets.exit().remove();
        pins = gadgets.selectAll('rect .pin').data(function(d) {
          return d.def.pins;
        });
        p = pins.enter();
        p.append('circle').attr({
          "class": 'pin',
          cx: (function(d) {
            return d.x + .5;
          }),
          cy: (function(d) {
            return d.y + .5;
          }),
          r: 3
        }).on('mousedown', function(d) {
          return console.log('c1', d);
        });
        p.append('text').text(function(d) {
          return d.name;
        }).attr({
          "class": function(d) {
            return d.dir;
          },
          x: function(d) {
            if (d.dir === 'in') {
              return d.x + 7;
            } else {
              return d.x - 7;
            }
          },
          y: function(d) {
            return d.y + 5;
          }
        });
        wires.enter().insert('path', 'g').attr({
          "class": 'wire',
          d: diag
        });
        wires.exit().remove();
        gadgets.attr({
          transform: function(d) {
            return "translate(" + d.x + "," + d.y + ")";
          }
        });
        return svg.on('mousedown', function() {
          return console.log('click!', d3.mouse(this));
        });
      }
    };
  });

  findPin = function(name, gdata) {
    var g, gid, p, pname, _i, _j, _len, _len1, _ref, _ref1;
    _ref = name.split('.'), gid = _ref[0], pname = _ref[1];
    for (_i = 0, _len = gdata.length; _i < _len; _i++) {
      g = gdata[_i];
      if (gid === g.id) {
        _ref1 = g.def.pins;
        for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
          p = _ref1[_j];
          if (pname === p.name) {
            return {
              y: g.x + p.x + .5,
              x: g.y + p.y + .5,
              g: g,
              p: p
            };
          }
        }
      }
    }
  };

  prepareData = function(gdefs, gdata) {
    var d, ins, n, outs, p, step, yIn, yOut, _i, _j, _k, _l, _len, _len1, _len2, _len3, _ref, _ref1, _ref2, _ref3, _results;
    for (n in gdefs) {
      d = gdefs[n];
      d.name || (d.name = n);
      ins = 0;
      _ref = d.pins;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        p = _ref[_i];
        p.x = d.width / 2;
        if (p.dir === 'in') {
          p.x = -p.x;
          ++ins;
        }
      }
      outs = d.pins.length - ins;
      step = 16;
      yIn = -(ins - 1) * step / 2;
      yOut = -(outs - 1) * step / 2;
      _ref1 = d.pins;
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        p = _ref1[_j];
        if (p.dir === 'in') {
          p.y = yIn;
          yIn += step;
        } else {
          p.y = yOut;
          yOut += step;
        }
      }
      d.height = 30 + step * (ins > outs ? ins : outs);
    }
    _ref2 = gdata.gadgets;
    for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
      d = _ref2[_k];
      d.def = gdefs[d.type];
      d.hw = d.def.width / 2;
      d.hh = d.def.height / 2;
    }
    _ref3 = gdata.wires;
    _results = [];
    for (_l = 0, _len3 = _ref3.length; _l < _len3; _l++) {
      d = _ref3[_l];
      d.source = findPin(d.from, gdata.gadgets);
      _results.push(d.target = findPin(d.to, gdata.gadgets));
    }
    return _results;
  };

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY2lyY2VkaXQuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQUEsTUFBQSx3QkFBQTs7QUFBQSxFQUFBLEVBQUEsR0FBSyxPQUFPLENBQUMsTUFBUixDQUFlLE9BQWYsQ0FBTCxDQUFBOztBQUFBLEVBRUEsRUFBRSxDQUFDLFNBQUgsQ0FBYSxlQUFiLEVBQThCLFNBQUEsR0FBQTtXQUM1QjtBQUFBLE1BQUEsUUFBQSxFQUFVLEdBQVY7QUFBQSxNQUVBLEtBQUEsRUFDRTtBQUFBLFFBQUEsSUFBQSxFQUFNLEdBQU47QUFBQSxRQUNBLElBQUEsRUFBTSxHQUROO09BSEY7QUFBQSxNQU1BLElBQUEsRUFBTSxTQUFDLEtBQUQsRUFBUSxJQUFSLEVBQWMsSUFBZCxHQUFBO0FBQ0osWUFBQSxpREFBQTtBQUFBLFFBQUEsV0FBQSxDQUFZLEtBQUssQ0FBQyxJQUFsQixFQUF3QixLQUFLLENBQUMsSUFBOUIsQ0FBQSxDQUFBO0FBQUEsUUFFQSxHQUFBLEdBQU0sRUFBRSxDQUFDLE1BQUgsQ0FBVSxJQUFLLENBQUEsQ0FBQSxDQUFmLENBQWtCLENBQUMsTUFBbkIsQ0FBMEIsS0FBMUIsQ0FDSixDQUFDLElBREcsQ0FDRTtBQUFBLFVBQUEsTUFBQSxFQUFRLEtBQVI7U0FERixDQUZOLENBQUE7QUFBQSxRQUlBLE9BQUEsR0FBVSxHQUFHLENBQUMsU0FBSixDQUFjLFNBQWQsQ0FBd0IsQ0FBQyxJQUF6QixDQUE4QixLQUFLLENBQUMsSUFBSSxDQUFDLE9BQXpDLEVBQWtELFNBQUMsQ0FBRCxHQUFBO2lCQUFPLENBQUMsQ0FBQyxHQUFUO1FBQUEsQ0FBbEQsQ0FKVixDQUFBO0FBQUEsUUFLQSxLQUFBLEdBQVEsR0FBRyxDQUFDLFNBQUosQ0FBYyxPQUFkLENBQXNCLENBQUMsSUFBdkIsQ0FBNEIsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUF2QyxDQUxSLENBQUE7QUFBQSxRQU9BLElBQUEsR0FBTyxFQUFF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ZSAnbXlBcHAnXG5cbm5nLmRpcmVjdGl2ZSAnY2lyY3VpdEVkaXRvcicsIC0+XG4gIHJlc3RyaWN0OiAnRSdcbiAgXG4gIHNjb3BlOlxuICAgIGRlZnM6ICc9J1xuICAgIGRhdGE6ICc9J1xuICAgIFxuICBsaW5rOiAoc2NvcGUsIGVsZW0sIGF0dHIpIC0+XG4gICAgcHJlcGFyZURhdGEgc2NvcGUuZGVmcywgc2NvcGUuZGF0YVxuICAgIFxuICAgIHN2ZyA9IGQzLnNlbGVjdChlbGVtWzBdKS5hcHBlbmQgJ3N2ZydcbiAgICAgIC5hdHRyIGhlaWdodDogXCI2MCVcIlxuICAgIGdhZGdldHMgPSBzdmcuc2VsZWN0QWxsKCcuZ2FkZ2V0JykuZGF0YSBzY29wZS5kYXRhLmdhZGdldHMsIChkKSAtPiBkLmlkXG4gICAgd2lyZXMgPSBzdmcuc2VsZWN0QWxsKCcud2lyZScpLmRhdGEgc2NvcGUuZGF0YS53aXJlc1xuXG4gICAgZGlhZyA9IGQzLnN2Zy5kaWFnb25hbCgpXG4gICAgICAucHJvamVjdGlvbiAoZCkgLT4gW2QueSwgZC54XSAjIHVuZG8gdGhlIHgveSByZXZlcnNhbCBmcm9tIGZpbmRQaW5cbiAgICBcbiAgICBnYWRnZXREcmFnID0gZDMuYmVoYXZpb3IuZHJhZygpXG4gICAgICAub3JpZ2luIE9iamVjdFxuICAgICAgLm9uICdkcmFnc3RhcnQnLCAoZCkgLT5cbiAgICAgICAgQHBhcmVudE5vZGUuYXBwZW5kQ2hpbGQgQCAjIG1vdmUgdG8gZnJvbnRcbiAgICAgICAgZDMuZXZlbnQuc291cmNlRXZlbnQuc3RvcFByb3BhZ2F0aW9uKClcbiAgICAgIC5vbiAnZHJhZycsIChkKSAtPlxuICAgICAgICBkLnggPSBkMy5ldmVudC54IHwgMCAjIHN0YXkgb24gaW50IGNvb3JkaW5hdGVzXG4gICAgICAgIGQueSA9IGQzLmV2ZW50LnkgfCAwICMgc3RheSBvbiBpbnQgY29vcmRpbmF0ZXNcbiAgICAgICAgZDMuc2VsZWN0KEApLmF0dHIgdHJhbnNmb3JtOiAoZCkgLT4gXCJ0cmFuc2xhdGUoI3tkLnh9LCN7ZC55fSlcIlxuICAgICAgICAjIHJlY2FsY3VsYXRlIGVuZHBvaW50cyBhbmQgcmVkcmF3IGFsbCB3aXJlcyBhdHRhY2hlZCB0byB0aGlzIGdhZGdldFxuICAgICAgICB3aXJlcy5maWx0ZXIgKHcpIC0+IHcuc291cmNlLmcgaXMgZCBvciB3LnRhcmdldC5nIGlzIGRcbiAgICAgICAgICAuZWFjaCAoZCkgLT5cbiAgICAgICAgICAgIGQuc291cmNlID0gZmluZFBpbiBkLmZyb20sIHNjb3BlLmRhdGEuZ2FkZ2V0c1xuICAgICAgICAgICAgZC50YXJnZXQgPSBmaW5kUGluIGQudG8sIHNjb3BlLmRhdGEuZ2FkZ2V0c1xuICAgICAgICAgIC5hdHRyIGQ6IGRpYWdcbiAgICAgIC5vbiAnZHJhZ2VuZCcsIChkKSAtPlxuICAgICAgICBjb25zb2xlLmxvZyAnc2F2ZSBnYWRnZXQnLCBkICMgVE9ETzogc2F2ZSB0byBzZXJ2ZXJcblxuICAgIGcgPSBnYWRnZXRzLmVudGVyKCkuYXBwZW5kKCdnJykuY2FsbChnYWRnZXREcmFnKVxuICAgICAgLmF0dHIgY2xhc3M6ICdnYWRnZXQnXG4gICAgZy5hcHBlbmQoJ3JlY3QnKVxuICAgICAgLmVhY2ggKGQpIC0+XG4gICAgICAgIGQzLnNlbGVjdChAKS5hdHRyXG4gICAgICAgICAgY2xhc3M6ICdvdXRsaW5lJ1xuICAgICAgICAgICMgMXB4IGxpbmVzIHJlbmRlciBzaGFycGx5IHdoZW4gb24gYSAwLjVweCBvZmZzZXRcbiAgICAgICAgICB4OiAwLjUgLSBkLmh3LCB5OiAwLjUgLSBkLmhoXG4gICAgICAgICAgd2lkdGg6IDIgKiBkLmh3LCBoZWlnaHQ6IDIgKiBkLmhoXG4gICAgICAuc3R5bGUgZmlsbDogKGQpIC0+IGQuZGVmLnNoYWRlXG4gICAgZy5hcHBlbmQoJ3RleHQnKS50ZXh0IChkKSAtPiBkLnRpdGxlXG4gICAgICAuYXR0ciBjbGFzczogJ3RpdGxlJywgeTogKGQpIC0+IDEyIC0gZC5oaFxuICAgIGcuYXBwZW5kKCd0ZXh0JykudGV4dCAoZCkgLT4gZC5kZWYubmFtZVxuICAgICAgLmF0dHIgY2xhc3M6ICd0eXBlJywgeTogKGQpIC0+IC00ICsgZC5oaFxuICAgIGcuYXBwZW5kKCd0ZXh0JykudGV4dCAoZCkgLT4gZC5kZWYuaWNvblxuICAgICAgLmF0dHIgY2xhc3M6ICdpY29uZm9udCcsIHg6IDAsIHk6IDBcbiAgICBnYWRnZXRzLmV4aXQoKS5yZW1vdmUoKVxuICAgICAgICBcbiAgICBwaW5zID0gZ2FkZ2V0cy5zZWxlY3RBbGwoJ3JlY3QgLnBpbicpLmRhdGEgKGQpIC0+IGQuZGVmLnBpbnNcbiAgICBwID0gcGlucy5lbnRlcigpXG4gICAgcC5hcHBlbmQoJ2NpcmNsZScpXG4gICAgICAuYXR0ciBjbGFzczogJ3BpbicsIGN4OiAoKGQpIC0+IGQueCsuNSksIGN5OiAoKGQpIC0+IGQueSsuNSksIHI6IDNcbiAgICAgIC5vbiAnbW91c2Vkb3duJywgKGQpIC0+XG4gICAgICAgIGNvbnNvbGUubG9nICdjMScsIGRcbiAgICBwLmFwcGVuZCgndGV4dCcpLnRleHQgKGQpIC0+IGQubmFtZVxuICAgICAgLmF0dHJcbiAgICAgICAgY2xhc3M6IChkKSAtPiBkLmRpclxuICAgICAgICB4OiAoZCkgLT4gaWYgZC5kaXIgaXMgJ2luJyB0aGVuIGQueCArIDcgZWxzZSBkLnggLSA3XG4gICAgICAgIHk6IChkKSAtPiBkLnkgKyA1XG5cbiAgICB3aXJlcy5lbnRlcigpLmluc2VydCgncGF0aCcsICdnJykgIyB1c2VzIGluc2VydCB0byBtb3ZlIHRvIGJhY2sgcmlnaHQgYXdheVxuICAgICAgLmF0dHIgY2xhc3M6ICd3aXJlJywgZDogZGlhZ1xuICAgIHdpcmVzLmV4aXQoKS5yZW1vdmUoKVxuXG4gICAgZ2FkZ2V0cy5hdHRyIHRyYW5zZm9ybTogKGQpIC0+IFwidHJhbnNsYXRlKCN7ZC54fSwje2QueX0pXCJcbiAgICBcbiAgICBzdmcub24gJ21vdXNlZG93bicsIC0+XG4gICAgICAjIHJldHVybiAgaWYgZDMuZXZlbnQuZGVmYXVsdFByZXZlbnRlZFxuICAgICAgY29uc29sZS5sb2cgJ2NsaWNrIScsIGQzLm1vdXNlIEBcblxuICAgICMgc3ZnLm9uICdjb250ZXh0bWVudScsIC0+XG4gICAgIyAgIGQzLmV2ZW50LnByZXZlbnREZWZhdWx0KCk7ICMgcHJldmVudCBicm93c2VyJ3MgY29udGV4dHVhbCBtZW51XG4gICAgIyAgIGNvbnNvbGUubG9nICdyaWdodCBjbGljayEnLCBkMy5ldmVudFxuXG5maW5kUGluID0gKG5hbWUsIGdkYXRhKSAtPlxuICBbZ2lkLHBuYW1lXSA9IG5hbWUuc3BsaXQgJy4nXG4gIGZvciBnIGluIGdkYXRhIHdoZW4gZ2lkIGlzIGcuaWRcbiAgICBmb3IgcCBpbiBnLmRlZi5waW5zIHdoZW4gcG5hbWUgaXMgcC5uYW1lXG4gICAgICAjIHJldmVyc2VzIHggYW5kIHkgYW5kIHVzZXMgcHJvamVjdGlvbiB0byBnZXQgaG9yaXpvbnRhbCBzcGxpbmVzXG4gICAgICByZXR1cm4geTogZy54ICsgcC54ICsgLjUsIHg6IGcueSArIHAueSArIC41LCBnOiBnLCBwOiBwXG5cbnByZXBhcmVEYXRhID0gKGdkZWZzLCBnZGF0YSkgLT5cbiAgIyBwcmUtY2FsY3VsYXRlIHNpemVzIGFuZCByZWxhdGl2ZSBwaW4gY29vcmRpbmF0ZXNcbiAgZm9yIG4sIGQgb2YgZ2RlZnNcbiAgICBkLm5hbWUgb3I9IG5cbiAgICBpbnMgPSAwXG4gICAgZm9yIHAgaW4gZC5waW5zXG4gICAgICBwLnggPSBkLndpZHRoIC8gMlxuICAgICAgaWYgcC5kaXIgaXMgJ2luJ1xuICAgICAgICBwLnggPSAtcC54XG4gICAgICAgICsraW5zXG4gICAgb3V0cyA9IGQucGlucy5sZW5ndGggLSBpbnNcbiAgICBzdGVwID0gMTZcbiAgICB5SW4gPSAtIChpbnMgLSAxKSAqIHN0ZXAgLyAyXG4gICAgeU91dCA9IC0gKG91dHMgLSAxKSAqIHN0ZXAgLyAyXG4gICAgZm9yIHAgaW4gZC5waW5zXG4gICAgICBpZiBwLmRpciBpcyAnaW4nXG4gICAgICAgIHAueSA9IHlJblxuICAgICAgICB5SW4gKz0gc3RlcFxuICAgICAgZWxzZVxuICAgICAgICBwLnkgPSB5T3V0XG4gICAgICAgIHlPdXQgKz0gc3RlcFxuICAgIGQuaGVpZ2h0ID0gMzAgKyBzdGVwICogKGlmIGlucyA+IG91dHMgdGhlbiBpbnMgZWxzZSBvdXRzKVxuXG4gIGZvciBkIGluIGdkYXRhLmdhZGdldHNcbiAgICBkLmRlZiA9IGdkZWZzW2QudHlwZV1cbiAgICBkLmh3ID0gZC5kZWYud2lkdGggLyAyXG4gICAgZC5oaCA9IGQuZGVmLmhlaWdodCAvIDJcblxuICBmb3IgZCBpbiBnZGF0YS53aXJlc1xuICAgIGQuc291cmNlID0gZmluZFBpbiBkLmZyb20sIGdkYXRhLmdhZGdldHNcbiAgICBkLnRhcmdldCA9IGZpbmRQaW4gZC50bywgZ2RhdGEuZ2FkZ2V0c1xuIl19
